<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>IPTV Player Kostenlos - Live TV Streaming, Filme & Serien Online Schauen | M3U Player Deutschland</title>
    <meta name="description" content="Free IPTV Player for Live TV Streaming, Movies and Series. M3U/M3U8 Player with HLS Support. Watch TV online for free, IPTV, Live TV Stream, Video on Demand. Best free IPTV Media Player 2025.">
    <meta name="keywords" content="IPTV Player, M3U Player, Live TV Streaming, kostenlos Fernsehen, IPTV Deutschland, M3U8 Player, HLS Player, Online TV, Gratis TV, Livestream, IPTV kostenlos, TV Stream, Internet TV, IPTV App, Web TV Player, Fernsehen online, Live Stream Player, Video Player, IPTV Playlist, M3U Liste, IPTV Germany, deutsches Fernsehen, TV online schauen, kostenloser Stream Player, IPTV Browser, Web IPTV, IPTV Software, Free IPTV, IPTV Mediaplayer, Smart IPTV, IPTV Pro, beste IPTV App, IPTV Empf√§nger, Streaming Player, VOD Player, Filme online schauen, Serien streamen, Gratis Streaming, kostenlose Filme, Online Mediaplayer">
    <meta name="author" content="IPTV Player">
    <meta name="robots" content="index, follow">
    <meta name="language" content="German">
    <meta name="revisit-after" content="7 days">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://iptv-player.de/">
    <meta property="og:title" content="IPTV Player Free - Live TV Streaming & Movies Online">
    <meta property="og:description" content="The best free IPTV Player for Live TV, Movies and Series. M3U/M3U8 Player with HLS Support. Watch TV online for free now!">
    <meta property="og:image" content="https://iptv-player.de/og-image.jpg">
    <meta property="og:locale" content="de_DE">
    <meta property="og:site_name" content="IPTV Player">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://iptv-player.de/">
    <meta name="twitter:title" content="IPTV Player Kostenlos - Live TV Streaming & Filme">
    <meta name="twitter:description" content="Free IPTV Player for Live TV, Movies and Series. M3U/M3U8 Support. Stream TV for free now!">
    <meta name="twitter:image" content="https://iptv-player.de/twitter-image.jpg">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://iptv-player.de/">
    
    <!-- Additional SEO -->
    <meta name="geo.region" content="DE">
    <meta name="geo.placename" content="Deutschland">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IPTV Player">
    
    <!-- Structured Data JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "IPTV Player",
      "description": "Free IPTV Player for Live TV Streaming, Movies and Series with M3U/M3U8 Support",
      "url": "https://iptv-player.de",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "EUR"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "1250"
      },
      "browserRequirements": "Requires JavaScript. Requires HTML5.",
      "featureList": "Live TV Streaming, M3U Player, M3U8 Player, HLS Support, Movies Online, Series Streaming, Playlist Manager, Favorites, Video on Demand",
      "screenshot": "https://iptv-player.de/screenshot.jpg",
      "softwareVersion": "2.0",
      "inLanguage": "de-DE",
      "author": {
        "@type": "Organization",
        "name": "IPTV Player"
      }
    }
    </script>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì∫</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            font-family: system-ui, -apple-system, sans-serif;
            transition: background 0.3s ease;
        }
        
        /* Light Theme */
        body.light-theme {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #1f2937;
        }
        body.light-theme .bg-gray-800 {
            background-color: #ffffff !important;
        }
        body.light-theme .bg-gray-900 {
            background-color: #f9fafb !important;
        }
        body.light-theme .text-white {
            color: #1f2937 !important;
        }
        body.light-theme .text-gray-300 {
            color: #6b7280 !important;
        }
        body.light-theme .text-gray-400 {
            color: #9ca3af !important;
        }
        body.light-theme .border-gray-700 {
            border-color: #e5e7eb !important;
        }
        body.light-theme .border-gray-800 {
            border-color: #d1d5db !important;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Platzhalter f√ºr fehlende Bilder */
        img[src=""] {
            display: none;
        }
        /* Animation f√ºr Toast-Benachrichtigung */
        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in {
            animation: slide-in 0.3s ease-out;
        }
        /* Spinner-Animation */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app"></div>

    <script>
        // App State
        let state = {
            channels: [],
            movies: [],
            series: [],
            seriesGroups: {}, // Gruppierte Serien mit Staffeln und Folgen
            currentChannel: null,
            currentMovie: null,
            selectedSeries: null, // Ausgew√§hlte Serie f√ºr Detail-Ansicht
            selectedSeason: null, // Ausgew√§hlte Staffel
            showSeriesDetail: false, // Zeige Serien-Detail Dialog
            favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
            playlists: JSON.parse(localStorage.getItem('playlists') || '[]'),
            playlistData: {}, // Tempor√§r im RAM, nicht in localStorage (zu gro√ü!)
            watchProgress: JSON.parse(localStorage.getItem('watchProgress') || '{}'), // Wiedergabefortschritt speichern
            searchQuery: '',
            selectedCategory: 'All Channels',
            selectedTab: 'live', // 'live', 'movies', 'series', 'favorites'
            favoriteFilter: 'all', // 'all', 'live', 'movies', 'series'
            isPlaying: false,
            isMuted: false,
            isFullscreen: false,
            playbackSpeed: 1,
            showUrlDialog: false,
            showXtreamDialog: false,
            showPlaylistManager: false,
            isLoadingPlaylists: false,
            sortBy: 'default', // 'default', 'name-asc', 'name-desc', 'date-asc', 'date-desc'
            viewMode: 'grid', // 'grid' or 'list'
            theme: localStorage.getItem('theme') || 'dark', // 'dark' or 'light'
            watchlist: JSON.parse(localStorage.getItem('watchlist') || '[]'),
            continueWatching: [], // Wird aus watchProgress generiert
            autoPlayNext: localStorage.getItem('autoPlayNext') === 'true',
            showIntroSkip: false,
            introSkipTime: 90, // Sekunden bis Intro-Skip erscheint
            ratings: JSON.parse(localStorage.getItem('ratings') || '{}'),
            tags: JSON.parse(localStorage.getItem('tags') || '{}'), // {itemId: ['tag1', 'tag2']}
            allTags: JSON.parse(localStorage.getItem('allTags') || '[]'), // Liste aller verf√ºgbaren Tags
            showAdvancedSearch: false,
            advancedFilters: {
                genre: '',
                year: '',
                minRating: 0,
                tags: []
            },
            epgData: {}, // {channelId: [{start, end, title, description}]}
            showEPG: false,
            selectedEPGChannel: null,
            audioTracks: [],
            subtitleTracks: [],
            currentAudioTrack: 0,
            currentSubtitleTrack: -1, // -1 = aus
            showSubtitleUpload: false,
            statistics: JSON.parse(localStorage.getItem('statistics') || '{}'), // {watchTime, viewCount per item}
            showStatistics: false,
            recommendations: [],
            
            // Phase 5: User Management
            users: JSON.parse(localStorage.getItem('users') || '[]'), // Array of user profiles
            currentUser: JSON.parse(localStorage.getItem('currentUser') || 'null'), // Currently logged in user
            showUserManager: false,
            showUserLogin: false,
            parentalControlEnabled: localStorage.getItem('parentalControlEnabled') === 'true',
            parentalControlPIN: localStorage.getItem('parentalControlPIN') || '',
            ageRestrictions: {}, // {userId: maxAge}
            timeLimits: {}, // {userId: {dailyLimit: minutes, currentTime: minutes}}
            cloudSyncEnabled: false,
            lastSyncTime: null,
            castAvailable: false,
            castConnected: false,
            castDevice: null
        };

        let hlsInstance = null;

        // Cache f√ºr fehlgeschlagene Bilder
        const failedImages = new Set();

        // Performance-Optimierungen
        let searchDebounceTimer = null;
        let renderScheduled = false;
        const ITEMS_PER_PAGE = 50; // F√ºr virtuelles Scrolling
        let currentPage = 1;

        // Event-Listener Referenzen (zur Vermeidung von Memory Leaks)
        let pauseListener = null;
        let beforeUnloadListenerRegistered = false;
        let scrollListenerContainer = null; // Container-Referenz f√ºr Infinite Scroll

        // Debounce Funktion
        function debounce(func, wait) {
            return function(...args) {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Sichere LocalStorage-Funktion mit Quota-Handling
        function safeLocalStorageSet(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    console.error('‚ö†Ô∏è LocalStorage Quota exceeded!');
                    
                    // Try to delete old data
                    try {
                        // Delete oldest Watch Progress entries
                        if (key === 'watchProgress' && state.watchProgress) {
                            const entries = Object.entries(state.watchProgress);
                            entries.sort((a, b) => {
                                const timeA = new Date(a[1].lastWatched || 0).getTime();
                                const timeB = new Date(b[1].lastWatched || 0).getTime();
                                return timeA - timeB;
                            });
                            
                            // L√∂sche √§lteste 20%
                            const toDelete = Math.ceil(entries.length * 0.2);
                            for (let i = 0; i < toDelete && i < entries.length; i++) {
                                delete state.watchProgress[entries[i][0]];
                            }
                            
                            console.log(`üóëÔ∏è ${toDelete} alte Watch-Progress Eintr√§ge gel√∂scht`);
                            localStorage.setItem(key, JSON.stringify(state.watchProgress));
                            return true;
                        }
                        
                        // F√ºr andere Keys: Zeige Warnung
                        alert('‚ö†Ô∏è Speicher voll! Bitte exportieren Sie Ihre Daten und l√∂schen Sie alte Eintr√§ge.');
                        return false;
                    } catch (retryError) {
                        console.error('Fehler beim Aufr√§umen:', retryError);
                        return false;
                    }
                } else {
                    console.error('LocalStorage Fehler:', e);
                    return false;
                }
            }
        }

        // Clean invalid favorites (IDs that no longer exist)
        function cleanupFavorites() {
            if (state.channels.length === 0 && state.movies.length === 0 && state.series.length === 0) {
                // No items loaded - if favorites exist, clear them
                if (state.favorites.length > 0) {
                    console.log('No channels/movies/series available - clearing all favorites');
                    state.favorites = [];
                    safeLocalStorageSet('favorites', JSON.stringify(state.favorites));
                    return true;
                }
                return false;
            }
            
            const allItemIds = [...state.channels, ...state.movies, ...state.series].map(item => item.id);
            const validFavorites = state.favorites.filter(favId => allItemIds.includes(favId));
            
            if (validFavorites.length !== state.favorites.length) {
                console.log(`Cleaning favorites: ${state.favorites.length} -> ${validFavorites.length}`);
                state.favorites = validFavorites;
                safeLocalStorageSet('favorites', JSON.stringify(state.favorites));
                return true; // Wurde ge√§ndert
            }
            return false; // Keine √Ñnderung
        }

        // HTML escape helper
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Bild-URL validieren
        function getValidImageUrl(url) {
            if (!url || failedImages.has(url)) {
                return null;
            }
            // Filtere URLs ohne Protokoll heraus
            if (!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('data:')) {
                failedImages.add(url);
                return null;
            }
            return url;
        }

        // Bild als fehlgeschlagen markieren
        function markImageAsFailed(url) {
            if (url) {
                failedImages.add(url);
            }
        }

        // Parse M3U File
        function parseM3U(content) {
            const lines = content.split('\n');
            const channels = [];
            const movies = [];
            const series = [];
            const seriesMap = {}; // F√ºr hierarchische Serien-Struktur
            let currentItem = {};

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line.startsWith('#EXTINF:')) {
                    const nameMatch = line.match(/,(.+)$/);
                    const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                    const groupMatch = line.match(/group-title="([^"]+)"/);
                    const idMatch = line.match(/tvg-id="([^"]+)"/);

                    const name = nameMatch ? nameMatch[1].trim() : 'Unbekannter Titel';
                    const category = groupMatch ? groupMatch[1] : 'Uncategorized';
                    
                    // Detect if it's a movie or series based on category or name patterns
                    const isMovie = category.toLowerCase().includes('film') || 
                                   category.toLowerCase().includes('movie') ||
                                   category.toLowerCase().includes('vod') ||
                                   name.match(/\(\d{4}\)/); // Year in parentheses
                    
                    const isSeries = category.toLowerCase().includes('serie') || 
                                    category.toLowerCase().includes('series') ||
                                    name.match(/S\d{2}E\d{2}/i); // Season/Episode pattern

                    currentItem = {
                        id: idMatch ? idMatch[1] : `item-${Date.now()}-${i}`,
                        name: name,
                        logo: logoMatch ? logoMatch[1] : null,
                        category: category,
                        type: isSeries ? 'series' : (isMovie ? 'movie' : 'live')
                    };
                } else if (line && !line.startsWith('#')) {
                    if (currentItem.name) {
                        currentItem.url = line;
                        
                        if (currentItem.type === 'movie') {
                            movies.push(currentItem);
                        } else if (currentItem.type === 'series') {
                            // Extrahiere Serien-Name, Staffel und Folge
                            const seriesInfo = parseSeriesName(currentItem.name);
                            currentItem.seriesName = seriesInfo.seriesName;
                            currentItem.season = seriesInfo.season;
                            currentItem.episode = seriesInfo.episode;
                            currentItem.episodeTitle = seriesInfo.episodeTitle;
                            
                            // Debug: Zeige erste Episode jeder Serie
                            if (!seriesMap[seriesInfo.seriesName]) {
                                console.log('üÜï Neue Serie erkannt:', {
                                    original: currentItem.name,
                                    seriesName: seriesInfo.seriesName,
                                    season: seriesInfo.season,
                                    episode: seriesInfo.episode
                                });
                            }
                            
                            series.push(currentItem);
                            
                            // Gruppiere nach Serien-Name
                            if (!seriesMap[seriesInfo.seriesName]) {
                                seriesMap[seriesInfo.seriesName] = {
                                    name: seriesInfo.seriesName,
                                    logo: currentItem.logo,
                                    category: currentItem.category,
                                    seasons: {}
                                };
                            }
                            
                            // Gruppiere nach Staffel
                            if (!seriesMap[seriesInfo.seriesName].seasons[seriesInfo.season]) {
                                seriesMap[seriesInfo.seriesName].seasons[seriesInfo.season] = [];
                                console.log(`üì∫ Neue Staffel: "${seriesInfo.seriesName}" S${seriesInfo.season}`);
                            }
                            
                            seriesMap[seriesInfo.seriesName].seasons[seriesInfo.season].push(currentItem);
                        } else {
                            channels.push(currentItem);
                        }
                        currentItem = {};
                    }
                }
            }

            // Debug Summary
            console.log('üìä Parse M3U Summary:', {
                totalChannels: channels.length,
                totalMovies: movies.length,
                totalEpisodes: series.length,
                uniqueSeries: Object.keys(seriesMap).length,
                seriesDetails: Object.keys(seriesMap).map(name => ({
                    name: name,
                    seasons: Object.keys(seriesMap[name].seasons).length,
                    totalEpisodes: Object.values(seriesMap[name].seasons).reduce((sum, eps) => sum + eps.length, 0)
                }))
            });

            return { channels, movies, series, seriesMap };
        }
        
        // Hilfsfunktion zum Parsen von Serien-Namen
        function parseSeriesName(fullName) {
            // Versuche verschiedene Serien-Namens-Muster zu erkennen
            // Format: "Serienname S01E02 - Episodentitel" oder "Serienname - S01E02" etc.
            
            // Pattern 1: "Name S01E02" oder "Name S1E2" oder "Name S01 E02" (mit Leerzeichen)
            // WICHTIG: Erfasse alles VOR S##E## als Serien-Name, egal was danach kommt
            let match = fullName.match(/^(.+?)\s+S(\d{1,2})\s*E(\d{1,2})(?:\s*[-:]\s*(.+))?$/i);
            if (match) {
                const result = {
                    seriesName: match[1].trim(),
                    season: parseInt(match[2]),
                    episode: parseInt(match[3]),
                    episodeTitle: match[4] ? match[4].trim() : `Episode ${parseInt(match[3])}`
                };
                console.log('‚úÖ Pattern 1 (S01E02):', fullName, '‚Üí', result.seriesName);
                return result;
            }
            
            // Pattern 2: "Name - Staffel 1 - Folge 2" (Deutsch)
            match = fullName.match(/^(.+?)\s*-\s*Staffel\s*(\d+)\s*-\s*Folge\s*(\d+)(?:\s*[-:]\s*(.+))?$/i);
            if (match) {
                const result = {
                    seriesName: match[1].trim(),
                    season: parseInt(match[2]),
                    episode: parseInt(match[3]),
                    episodeTitle: match[4] ? match[4].trim() : `Folge ${parseInt(match[3])}`
                };
                console.log('‚úÖ Pattern 2 (Staffel/Folge):', fullName, '‚Üí', result.seriesName);
                return result;
            }
            
            // Pattern 3: "Name Season 1 Episode 2" (Englisch)
            match = fullName.match(/^(.+?)\s+Season\s*(\d+)\s*Episode\s*(\d+)(?:\s*[-:]\s*(.+))?$/i);
            if (match) {
                const result = {
                    seriesName: match[1].trim(),
                    season: parseInt(match[2]),
                    episode: parseInt(match[3]),
                    episodeTitle: match[4] ? match[4].trim() : `Episode ${parseInt(match[3])}`
                };
                console.log('‚úÖ Pattern 3 (Season/Episode):', fullName, '‚Üí', result.seriesName);
                return result;
            }
            
            // Pattern 4: "Name 1x02" Format
            match = fullName.match(/^(.+?)\s+(\d+)x(\d+)(?:\s*[-:]\s*(.+))?$/i);
            if (match) {
                const result = {
                    seriesName: match[1].trim(),
                    season: parseInt(match[2]),
                    episode: parseInt(match[3]),
                    episodeTitle: match[4] ? match[4].trim() : `Episode ${parseInt(match[3])}`
                };
                console.log('‚úÖ Pattern 4 (1x02):', fullName, '‚Üí', result.seriesName);
                return result;
            }
            
            // Fallback: Wenn kein Muster erkannt wird
            console.warn('‚ö†Ô∏è Kein Pattern gefunden f√ºr:', fullName);
            return {
                seriesName: fullName,
                season: 1,
                episode: 1,
                episodeTitle: fullName
            };
        }

        // Get filtered channels
        function getFilteredChannels(paginate = false) {
            let items = [];
            
            if (state.selectedTab === 'favorites') {
                // Alle Items (Kan√§le, Filme, Serien) sammeln
                let allItems = [...state.channels, ...state.movies, ...state.series];
                // Nur Favoriten filtern
                items = allItems.filter(item => state.favorites.includes(item.id));
                
                // Nach Typ filtern wenn gew√ºnscht
                if (state.favoriteFilter === 'live') {
                    items = items.filter(item => item.type === 'live' || !item.type);
                } else if (state.favoriteFilter === 'movies') {
                    items = items.filter(item => item.type === 'movie');
                } else if (state.favoriteFilter === 'series') {
                    items = items.filter(item => item.type === 'series');
                }
            } else if (state.selectedTab === 'live') {
                items = state.channels;
            } else if (state.selectedTab === 'movies') {
                items = state.movies;
            } else if (state.selectedTab === 'series') {
                // F√ºr Serien: Zeige gruppierte Serien (eine Karte pro Serie)
                const seriesArray = Object.values(state.seriesGroups);
                console.log('üé¨ Serien-Tab:', {
                    seriesGroups: Object.keys(state.seriesGroups).length,
                    seriesArray: seriesArray.length,
                    einzelneEpisoden: state.series.length
                });
                items = seriesArray.map(series => ({
                    id: `series-${series.name}`,
                    name: series.name,
                    logo: series.logo,
                    category: series.category,
                    type: 'series',
                    seriesData: series,
                    // Z√§hle Staffeln und Folgen
                    seasonCount: Object.keys(series.seasons || {}).length,
                    episodeCount: Object.values(series.seasons || {}).reduce((sum, episodes) => sum + episodes.length, 0)
                }));
            }

            if (state.selectedCategory !== 'All Channels' && state.selectedCategory !== 'All Movies' && state.selectedCategory !== 'All Series' && state.selectedCategory !== 'All Favorites') {
                items = items.filter(ch => ch.category === state.selectedCategory);
            }

            if (state.searchQuery) {
                const query = state.searchQuery.toLowerCase();
                items = items.filter(ch => 
                    ch.name.toLowerCase().includes(query) ||
                    (ch.category && ch.category.toLowerCase().includes(query)) ||
                    (ch.seriesName && ch.seriesName.toLowerCase().includes(query))
                );
            }

            // Erweiterte Filter anwenden
            if (state.selectedTab !== 'live') {
                // Genre/Kategorie Filter
                if (state.advancedFilters.genre) {
                    items = items.filter(item => 
                        item.category && item.category.toLowerCase().includes(state.advancedFilters.genre.toLowerCase())
                    );
                }
                
                // Jahr Filter (aus Namen extrahieren wenn vorhanden)
                if (state.advancedFilters.year) {
                    items = items.filter(item => item.name.includes(state.advancedFilters.year));
                }
                
                // Bewertungs-Filter
                if (state.advancedFilters.minRating > 0) {
                    items = items.filter(item => {
                        const rating = getAverageRating(item.id);
                        return rating >= state.advancedFilters.minRating;
                    });
                }
                
                // Tag Filter
                if (state.advancedFilters.tags.length > 0) {
                    items = items.filter(item => {
                        const itemTags = getItemTags(item.id);
                        return state.advancedFilters.tags.some(tag => itemTags.includes(tag));
                    });
                }
            }

            // Sortierung anwenden
            if (state.sortBy !== 'default') {
                items = [...items].sort((a, b) => {
                    if (state.sortBy === 'name-asc') {
                        return a.name.localeCompare(b.name);
                    } else if (state.sortBy === 'name-desc') {
                        return b.name.localeCompare(a.name);
                    } else if (state.sortBy === 'date-asc') {
                        // √Ñlteste zuerst
                        return (a.id || '').localeCompare(b.id || '');
                    } else if (state.sortBy === 'date-desc') {
                        // Neueste zuerst
                        return (b.id || '').localeCompare(a.id || '');
                    }
                    return 0;
                });
            }

            // Virtuelles Scrolling f√ºr bessere Performance bei gro√üen Listen
            if (paginate && items.length > ITEMS_PER_PAGE) {
                const start = 0;
                const end = currentPage * ITEMS_PER_PAGE;
                return items.slice(start, end);
            }

            return items;
        }

        // Get categories
        function getCategories() {
            let items = [];
            let prefix = 'All Channels';
            
            if (state.selectedTab === 'favorites') {
                // F√ºr Favoriten: alle favorisierten Items
                let allItems = [...state.channels, ...state.movies, ...state.series];
                items = allItems.filter(item => state.favorites.includes(item.id));
                prefix = 'All Favorites';
            } else if (state.selectedTab === 'live') {
                items = state.channels;
                prefix = 'All Channels';
            } else if (state.selectedTab === 'movies') {
                items = state.movies;
                prefix = 'All Movies';
            } else if (state.selectedTab === 'series') {
                // F√ºr Serien: Verwende gruppierte Serien
                items = Object.values(state.seriesGroups);
                prefix = 'All Series';
            }
            
            const categories = [prefix];
            const uniqueCategories = [...new Set(items.map(ch => ch.category))];
            return categories.concat(uniqueCategories.sort());
        }

        // Toggle favorite
        function toggleFavorite(channelId) {
            const index = state.favorites.indexOf(channelId);
            if (index > -1) {
                state.favorites.splice(index, 1);
            } else {
                state.favorites.push(channelId);
            }
            safeLocalStorageSet('favorites', JSON.stringify(state.favorites));
            saveCurrentUserData(); // Auto-save f√ºr eingeloggten Benutzer
            renderTabs(); // Tab-Counter aktualisieren
            renderChannelList(); // Kanal-Liste neu rendern
        }

        // Select channel
        function selectChannel(itemId) {
            // Pr√ºfe ob es sich um eine Serie handelt (wird anders behandelt)
            if (itemId.startsWith('series-')) {
                const seriesName = itemId.replace('series-', '');
                openSeriesDetail(seriesName);
                return;
            }
            
            let allItems = [...state.channels, ...state.movies, ...state.series];
            const item = allItems.find(i => i.id === itemId);
            if (!item) {
                console.warn('Channel not found:', itemId);
                return;
            }
            
            // Pause and cleanup before changing state
            const video = document.getElementById('videoPlayer');
            if (video) {
                video.pause();
                state.isPlaying = false;
            }
            
            // Cleanup previous HLS instance before state change
            if (hlsInstance) {
                try {
                    // Detach all event listeners
                    hlsInstance.off(Hls.Events.MANIFEST_PARSED);
                    hlsInstance.off(Hls.Events.ERROR);
                    hlsInstance.off(Hls.Events.MEDIA_ATTACHED);
                    hlsInstance.off(Hls.Events.LEVEL_LOADED);
                    hlsInstance.off(Hls.Events.AUDIO_TRACKS_UPDATED);
                    hlsInstance.off(Hls.Events.SUBTITLE_TRACKS_UPDATED);
                    
                    hlsInstance.destroy();
                } catch (e) {
                    console.warn('‚ö†Ô∏è HLS Cleanup Fehler:', e);
                    try {
                        if (hlsInstance.media) {
                            hlsInstance.detachMedia();
                        }
                    } catch (detachError) {
                        console.warn('Detach fehlgeschlagen:', detachError);
                    }
                }
                hlsInstance = null;
            }
            
            if (state.selectedTab === 'live') {
                state.currentChannel = item;
                state.currentMovie = null;
            } else {
                state.currentMovie = item;
                state.currentChannel = null;
            }
            
            // UI aktualisieren
            renderChannelList();
            renderVideoPlayer();
            
            // Video laden nach kurzer Verz√∂gerung, damit DOM aktualisiert ist
            setTimeout(() => {
                loadVideo(item);
            }, 100);
        }
        
        // √ñffne Serien-Detail Dialog
        function openSeriesDetail(seriesName) {
            const series = state.seriesGroups[seriesName];
            if (!series) {
                console.warn('Series not found:', seriesName);
                return;
            }
            
            state.selectedSeries = series;
            state.showSeriesDetail = true;
            
            // W√§hle erste Staffel automatisch
            const seasons = Object.keys(series.seasons).sort((a, b) => parseInt(a) - parseInt(b));
            if (seasons.length > 0) {
                state.selectedSeason = parseInt(seasons[0]);
            }
            
            render(); // Voller Render f√ºr Dialog
        }
        
        // Schlie√üe Serien-Detail Dialog
        function closeSeriesDetail() {
            state.showSeriesDetail = false;
            state.selectedSeries = null;
            state.selectedSeason = null;
            render();
        }
        
        // W√§hle Staffel
        function selectSeason(seasonNumber) {
            state.selectedSeason = seasonNumber;
            render();
        }
        
        // Spiele Episode ab
        function playEpisode(episodeId) {
            // Finde Episode
            const episode = state.series.find(ep => ep.id === episodeId);
            if (!episode) {
                console.warn('Episode not found:', episodeId);
                return;
            }
            
            // Schlie√üe Dialog
            state.showSeriesDetail = false;
            
            // Setze currentMovie
            state.currentMovie = episode;
            state.currentChannel = null;
            
            // UI aktualisieren
            renderChannelList();
            renderVideoPlayer();
            
            // Video laden
            setTimeout(() => {
                loadVideo(episode);
            }, 100);
        }

        // Load video
        function loadVideo(item) {
            const video = document.getElementById('videoPlayer');
            if (!video) {
                console.warn('Video element not found, retrying...');
                // Warte kurz und versuche es erneut
                setTimeout(() => loadVideo(item), 100);
                return;
            }
            
            if (!item || !item.url) {
                console.error('No valid item or URL provided:', item);
                return;
            }

            console.log('Loading video:', item.name, 'URL:', item.url);

            // Track view statistics
            trackView(item.id);
            
            // Generate recommendations based on viewing
            generateRecommendations();

            // Pause video first to avoid AbortError
            try {
                video.pause();
            } catch (e) {
                console.warn('Could not pause video:', e);
            }

            // Cleanup previous HLS instance
            if (hlsInstance) {
                try {
                    // Detach all event listeners before destroying
                    hlsInstance.off(Hls.Events.MANIFEST_PARSED);
                    hlsInstance.off(Hls.Events.ERROR);
                    hlsInstance.off(Hls.Events.MEDIA_ATTACHED);
                    hlsInstance.off(Hls.Events.LEVEL_LOADED);
                    hlsInstance.off(Hls.Events.AUDIO_TRACKS_UPDATED);
                    hlsInstance.off(Hls.Events.SUBTITLE_TRACKS_UPDATED);
                    
                    // Destroy HLS instance
                    hlsInstance.destroy();
                    console.log('‚úì HLS Instance erfolgreich bereinigt');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Fehler beim HLS Cleanup:', e);
                    // Force cleanup even on error
                    try {
                        if (hlsInstance.media) {
                            hlsInstance.detachMedia();
                        }
                    } catch (detachError) {
                        console.warn('Detach fehlgeschlagen:', detachError);
                    }
                }
                hlsInstance = null;
            }

            // Reset video source
            video.removeAttribute('src');
            video.load();

            // Check if URL is HLS stream (.m3u8 or IPTV-style URLs)
            const isHLS = item.url.includes('.m3u8') || 
                          item.url.includes('/get.php') || 
                          item.url.match(/:\d+\/[^\/]+\/[^\/]+\/\d+$/); // IPTV URL pattern
            
            if (isHLS) {
                if (Hls.isSupported()) {
                    console.log('Using HLS.js for playback');
                    hlsInstance = new Hls({
                        enableWorker: true,
                        lowLatencyMode: false, // Deaktiviert f√ºr stabileres Streaming
                        maxBufferLength: 60, // Erh√∂ht f√ºr weniger Buffering
                        maxMaxBufferLength: 120,
                        maxBufferSize: 100 * 1000 * 1000, // 100 MB
                        maxBufferHole: 0.8,
                        backBufferLength: 30, // Behalte 30s zur√ºck
                        frontBufferFlushThreshold: 90, // R√§ume Buffer bei 90s auf
                        highBufferWatchdogPeriod: 3,
                        nudgeMaxRetry: 5,
                        manifestLoadingTimeOut: 15000,
                        manifestLoadingMaxRetry: 4,
                        levelLoadingTimeOut: 15000,
                        fragLoadingTimeOut: 30000,
                        startFragPrefetch: true, // Prefetch f√ºr schnellere Starts
                        testBandwidth: true,
                        abrEwmaDefaultEstimate: 500000, // 500 kbps initial
                        abrBandWidthFactor: 0.95, // Konservativeres ABR
                        abrBandWidthUpFactor: 0.7,
                        progressive: true
                    });
                    
                    hlsInstance.loadSource(item.url);
                    hlsInstance.attachMedia(video);
                    
                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                        // Wiedergabefortschritt wiederherstellen (nur f√ºr Filme/Serien)
                        if ((item.type === 'movie' || item.type === 'series') && state.watchProgress[item.id]) {
                            const savedTime = state.watchProgress[item.id].currentTime;
                            const duration = state.watchProgress[item.id].duration;
                            // Nur fortsetzen wenn nicht fast am Ende (< 95%)
                            if (savedTime > 5 && savedTime < duration * 0.95) {
                                video.currentTime = savedTime;
                                console.log(`Fortsetzen bei ${Math.floor(savedTime)}s`);
                                showResumeNotification(savedTime, duration);
                            }
                        }
                        
                        video.play().then(() => {
                            state.isPlaying = true;
                            console.log('‚úì Video playing:', item.name);
                            // Starte Fortschritts-Tracking
                            startProgressTracking(item, video);
                        }).catch(err => {
                            console.warn('‚ö† Autoplay prevented:', err.message);
                            console.log('üëÜ Click play button to start video');
                            state.isPlaying = false;
                            renderVideoPlayer(); // Update UI to show play button
                        });
                    });

                    hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                        console.error('HLS Error:', data.type, data.details);
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.error('‚úó Fatal network error, trying to recover');
                                    hlsInstance.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.error('‚úó Fatal media error, trying to recover');
                                    hlsInstance.recoverMediaError();
                                    break;
                                default:
                                    console.error('‚úó Cannot recover from error');
                                    state.isPlaying = false;
                                    renderVideoPlayer();
                                    break;
                            }
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    // Native HLS support (Safari)
                    console.log('Using native HLS playback');
                    video.src = item.url;
                    video.load();
                    
                    // Wiedergabefortschritt wiederherstellen
                    video.addEventListener('loadedmetadata', () => {
                        // Detect audio and subtitle tracks
                        detectAudioTracks();
                        
                        if ((item.type === 'movie' || item.type === 'series') && state.watchProgress[item.id]) {
                            const savedTime = state.watchProgress[item.id].currentTime;
                            const duration = state.watchProgress[item.id].duration;
                            if (savedTime > 5 && savedTime < duration * 0.95) {
                                video.currentTime = savedTime;
                                console.log(`Fortsetzen bei ${Math.floor(savedTime)}s`);
                                showResumeNotification(savedTime, duration);
                            }
                        }
                    }, { once: true });
                    
                    video.play().then(() => {
                        state.isPlaying = true;
                        console.log('‚úì Video playing (native):', item.name);
                        startProgressTracking(item, video);
                    }).catch(err => {
                        console.warn('‚ö† Autoplay prevented:', err.message);
                        state.isPlaying = false;
                        renderVideoPlayer();
                    });
                } else {
                    console.error('‚úó HLS not supported in this browser');
                }
            } else {
                // Direct stream (MP4, WebM, etc.)
                console.log('Using direct stream playback');
                video.src = item.url;
                video.load();
                
                // Wiedergabefortschritt wiederherstellen
                video.addEventListener('loadedmetadata', () => {
                    // Detect audio and subtitle tracks
                    detectAudioTracks();
                    
                    if ((item.type === 'movie' || item.type === 'series') && state.watchProgress[item.id]) {
                        const savedTime = state.watchProgress[item.id].currentTime;
                        const duration = state.watchProgress[item.id].duration;
                        if (savedTime > 5 && savedTime < duration * 0.95) {
                            video.currentTime = savedTime;
                            console.log(`Fortsetzen bei ${Math.floor(savedTime)}s`);
                            showResumeNotification(savedTime, duration);
                        }
                    }
                }, { once: true });
                
                video.play().then(() => {
                    state.isPlaying = true;
                    console.log('‚úì Video playing (direct):', item.name);
                    startProgressTracking(item, video);
                }).catch(err => {
                    console.warn('‚ö† Playback error:', err.message);
                    state.isPlaying = false;
                    renderVideoPlayer();
                });
            }
        }

        // Fortschritts-Tracking f√ºr Filme/Serien
        let progressInterval = null;
        let introSkipTimeout = null;
        let watchTimeTracker = null;
        
        function startProgressTracking(item, video) {
            // Stoppe vorheriges Tracking
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            if (introSkipTimeout) {
                clearTimeout(introSkipTimeout);
            }
            if (watchTimeTracker) {
                clearInterval(watchTimeTracker);
            }
            
            // Watch-Time Tracking (f√ºr alle Typen)
            let lastTrackedTime = Date.now();
            watchTimeTracker = setInterval(() => {
                if (video && !video.paused) {
                    const now = Date.now();
                    const elapsed = (now - lastTrackedTime) / 1000; // Sekunden
                    trackWatchTime(item.id, elapsed);
                    lastTrackedTime = now;
                }
            }, 10000); // Alle 10 Sekunden
            
            // Nur f√ºr Filme und Serien tracken, nicht f√ºr Live TV
            if (item.type !== 'movie' && item.type !== 'series') {
                return;
            }
            
            // Intro Skip nach bestimmter Zeit anzeigen
            if (item.type === 'series') {
                introSkipTimeout = setTimeout(() => {
                    if (video.currentTime < state.introSkipTime + 10) {
                        state.showIntroSkip = true;
                        renderVideoPlayer();
                    }
                }, 5000); // Nach 5 Sekunden
            }
            
            // Speichere Fortschritt alle 5 Sekunden
            progressInterval = setInterval(() => {
                if (video && !video.paused && video.duration > 0) {
                    saveWatchProgress(item.id, video.currentTime, video.duration);
                    
                    // Auto-Play Check: Wenn fast am Ende (letzten 10 Sekunden)
                    if (state.autoPlayNext && item.type === 'series') {
                        const timeRemaining = video.duration - video.currentTime;
                        if (timeRemaining <= 10 && timeRemaining > 0) {
                            const nextEpisode = findNextEpisode(item);
                            if (nextEpisode) {
                                showAutoPlayCountdown(timeRemaining, nextEpisode);
                            }
                        }
                    }
                }
            }, 5000);
            
            // Event Listener f√ºr Video-Ende
            video.addEventListener('ended', () => {
                if (state.autoPlayNext && item.type === 'series') {
                    playNextEpisode();
                }
            }, { once: true });
            
            // Entferne alten Pause-Listener wenn vorhanden
            if (pauseListener) {
                video.removeEventListener('pause', pauseListener);
            }
            
            // Erstelle neuen Pause-Listener
            pauseListener = () => {
                if (video && video.duration > 0) {
                    saveWatchProgress(item.id, video.currentTime, video.duration);
                }
            };
            
            // Speichere auch bei Pause
            video.addEventListener('pause', pauseListener);
            
            // Registriere beforeunload Handler nur einmal f√ºr gesamte App
            if (!beforeUnloadListenerRegistered) {
                window.addEventListener('beforeunload', () => {
                    const videoElement = document.getElementById('videoPlayer');
                    if (videoElement && videoElement.duration > 0) {
                        const activeItem = state.currentChannel || state.currentMovie;
                        if (activeItem) {
                            saveWatchProgress(activeItem.id, videoElement.currentTime, videoElement.duration);
                        }
                    }
                });
                beforeUnloadListenerRegistered = true;
                console.log('‚úì beforeunload Handler registriert (einmalig)');
            }
        }

        // Speichere Wiedergabefortschritt
        function saveWatchProgress(itemId, currentTime, duration) {
            // Speichere nur wenn mehr als 5 Sekunden angeschaut
            if (currentTime < 5) return;
            
            // L√∂sche Fortschritt wenn fast am Ende (> 95%)
            if (currentTime > duration * 0.95) {
                delete state.watchProgress[itemId];
                safeLocalStorageSet('watchProgress', JSON.stringify(state.watchProgress));
                console.log('Film/Serie abgeschlossen, Fortschritt gel√∂scht');
                return;
            }
            
            state.watchProgress[itemId] = {
                currentTime: Math.floor(currentTime),
                duration: Math.floor(duration),
                lastWatched: new Date().toISOString()
            };
            
            // Speichere in localStorage
            try {
                safeLocalStorageSet('watchProgress', JSON.stringify(state.watchProgress));
                saveCurrentUserData(); // Auto-save f√ºr eingeloggten Benutzer
            } catch (e) {
                console.warn('Konnte Fortschritt nicht speichern:', e);
            }
        }

        // Zeige Fortsetzen-Benachrichtigung
        function showResumeNotification(currentTime, duration) {
            const minutes = Math.floor(currentTime / 60);
            const seconds = Math.floor(currentTime % 60);
            const percent = Math.floor((currentTime / duration) * 100);
            
            // Erstelle Toast-Benachrichtigung
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in';
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <p class="font-semibold">Fortsetzen bei ${minutes}:${seconds.toString().padStart(2, '0')}</p>
                        <p class="text-sm opacity-90">${percent}% angeschaut</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Entferne Toast nach 5 Sekunden
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Auto-Play Countdown anzeigen
        let autoPlayCountdownInterval = null;
        function showAutoPlayCountdown(timeRemaining, nextEpisode) {
            // Entferne vorherigen Countdown
            const existingCountdown = document.getElementById('autoPlayCountdown');
            if (existingCountdown) return; // Bereits angezeigt
            
            const countdown = document.createElement('div');
            countdown.id = 'autoPlayCountdown';
            countdown.className = 'fixed bottom-24 right-4 bg-gray-900/95 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-slide-in border-2 border-blue-600';
            
            let secondsLeft = Math.ceil(timeRemaining);
            
            const updateCountdown = () => {
                countdown.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-400">${secondsLeft}</div>
                            <div class="text-xs text-gray-400">Sekunden</div>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold mb-1">N√§chste Episode</div>
                            <div class="text-sm text-gray-300">${escapeHtml(nextEpisode.name)}</div>
                        </div>
                        <button
                            onclick="cancelAutoPlay()"
                            class="p-2 hover:bg-white/10 rounded-lg transition"
                            title="Abbrechen"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;
            };
            
            updateCountdown();
            document.body.appendChild(countdown);
            
            autoPlayCountdownInterval = setInterval(() => {
                secondsLeft--;
                if (secondsLeft <= 0) {
                    clearInterval(autoPlayCountdownInterval);
                    countdown.remove();
                } else {
                    updateCountdown();
                }
            }, 1000);
        }

        // Cancel Auto-Play
        function cancelAutoPlay() {
            if (autoPlayCountdownInterval) {
                clearInterval(autoPlayCountdownInterval);
            }
            const countdown = document.getElementById('autoPlayCountdown');
            if (countdown) {
                countdown.remove();
            }
        }

        // Skip Intro
        function skipIntro() {
            const video = document.getElementById('videoPlayer');
            if (video) {
                video.currentTime = state.introSkipTime;
                state.showIntroSkip = false;
                renderVideoPlayer();
            }
        }

        // Toggle play/pause
        function togglePlay() {
            const video = document.getElementById('videoPlayer');
            if (!video) return;
            
            if (state.isPlaying) {
                video.pause();
                state.isPlaying = false;
                renderVideoPlayer();
            } else {
                video.play().then(() => {
                    state.isPlaying = true;
                    renderVideoPlayer();
                }).catch(err => {
                    console.warn('Play prevented:', err.message);
                    state.isPlaying = false;
                    renderVideoPlayer();
                });
            }
        }

        // Toggle mute
        function toggleMute() {
            const video = document.getElementById('videoPlayer');
            if (!video) return;
            video.muted = !state.isMuted;
            state.isMuted = !state.isMuted;
            // UI aktualisieren
            renderVideoPlayer();
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            const video = document.getElementById('videoPlayer');
            if (!video) return;
            
            if (!state.isFullscreen) {
                if (video.requestFullscreen) {
                    video.requestFullscreen();
                } else if (video.webkitRequestFullscreen) {
                    video.webkitRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
            state.isFullscreen = !state.isFullscreen;
        }

        // Change playback speed
        function changePlaybackSpeed(speed) {
            const video = document.getElementById('videoPlayer');
            if (!video) return;
            
            state.playbackSpeed = speed;
            video.playbackRate = speed;
            renderVideoPlayer();
        }

        // Toggle Picture-in-Picture
        function togglePictureInPicture() {
            const video = document.getElementById('videoPlayer');
            if (!video) return;
            
            if (document.pictureInPictureElement) {
                document.exitPictureInPicture();
            } else if (document.pictureInPictureEnabled) {
                video.requestPictureInPicture().catch(err => {
                    console.warn('PiP not available:', err);
                });
            }
        }

        // Change sort order
        function changeSortOrder(sortBy) {
            state.sortBy = sortBy;
            currentPage = 1;
            renderChannelList();
        }

        // Toggle view mode
        function toggleViewMode() {
            state.viewMode = state.viewMode === 'grid' ? 'list' : 'grid';
            renderChannelList();
        }

        // Toggle theme
        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            safeLocalStorageSet('theme', state.theme);
            saveCurrentUserData(); // Auto-save f√ºr eingeloggten Benutzer
            applyTheme();
        }

        // Apply theme
        function applyTheme() {
            if (state.theme === 'light') {
                document.body.style.background = 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)';
                document.body.classList.add('light-theme');
            } else {
                document.body.style.background = 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)';
                document.body.classList.remove('light-theme');
            }
        }

        // Toggle watchlist
        function toggleWatchlist(itemId) {
            const index = state.watchlist.indexOf(itemId);
            if (index > -1) {
                state.watchlist.splice(index, 1);
            } else {
                state.watchlist.push(itemId);
            }
            safeLocalStorageSet('watchlist', JSON.stringify(state.watchlist));
            saveCurrentUserData(); // Auto-save f√ºr eingeloggten Benutzer
            renderChannelList();
        }

        // Get continue watching items
        function getContinueWatching() {
            const items = [];
            for (const itemId in state.watchProgress) {
                const progress = state.watchProgress[itemId];
                // Finde das Item
                const item = [...state.movies, ...state.series].find(i => i.id === itemId);
                if (item && progress.currentTime > 30 && progress.currentTime < progress.duration * 0.95) {
                    items.push({
                        ...item,
                        progress: progress,
                        lastWatched: new Date(progress.lastWatched)
                    });
                }
            }
            // Sortiere nach zuletzt angeschaut
            return items.sort((a, b) => b.lastWatched - a.lastWatched);
        }

        // Toggle auto-play next
        function toggleAutoPlay() {
            state.autoPlayNext = !state.autoPlayNext;
            safeLocalStorageSet('autoPlayNext', String(state.autoPlayNext));
            render();
        }

        // Find next episode
        function findNextEpisode(currentItem) {
            if (!currentItem || !currentItem.seriesName) return null;
            
            const seriesGroup = state.seriesGroups[currentItem.seriesName];
            if (!seriesGroup) return null;
            
            const season = seriesGroup.seasons[currentItem.season];
            if (!season) return null;
            
            // Suche n√§chste Episode in gleicher Staffel
            const nextEpisode = season.find(ep => ep.episode === currentItem.episode + 1);
            if (nextEpisode) return nextEpisode;
            
            // Suche erste Episode der n√§chsten Staffel
            const nextSeasonNum = currentItem.season + 1;
            const nextSeason = seriesGroup.seasons[nextSeasonNum];
            if (nextSeason && nextSeason.length > 0) {
                return nextSeason[0];
            }
            
            return null;
        }

        // Play next episode
        function playNextEpisode() {
            const currentItem = state.currentMovie;
            if (!currentItem) return;
            
            const nextEpisode = findNextEpisode(currentItem);
            if (nextEpisode) {
                selectChannel(nextEpisode.id);
            }
        }

        // Rating System
        function rateItem(itemId, rating) {
            state.ratings[itemId] = rating;
            safeLocalStorageSet('ratings', JSON.stringify(state.ratings));
            saveCurrentUserData(); // Auto-save f√ºr eingeloggten Benutzer
            renderChannelList();
        }

        function getAverageRating(itemId) {
            return state.ratings[itemId] || 0;
        }

        // Tag System
        function toggleTag(itemId, tag) {
            if (!state.tags[itemId]) {
                state.tags[itemId] = [];
            }
            
            const index = state.tags[itemId].indexOf(tag);
            if (index > -1) {
                state.tags[itemId].splice(index, 1);
            } else {
                state.tags[itemId].push(tag);
            }
            
            // Update allTags wenn neuer Tag
            if (!state.allTags.includes(tag)) {
                state.allTags.push(tag);
                safeLocalStorageSet('allTags', JSON.stringify(state.allTags));
            }
            
            safeLocalStorageSet('tags', JSON.stringify(state.tags));
            saveCurrentUserData(); // Auto-save f√ºr eingeloggten Benutzer
            renderChannelList();
        }

        function addNewTag(itemId, tagName) {
            const tag = tagName.trim();
            if (!tag) return;
            
            toggleTag(itemId, tag);
        }

        function getItemTags(itemId) {
            return state.tags[itemId] || [];
        }

        // Advanced Search
        function toggleAdvancedSearch() {
            state.showAdvancedSearch = !state.showAdvancedSearch;
            render();
        }

        function applyAdvancedFilters() {
            currentPage = 1;
            renderChannelList();
        }

        function resetAdvancedFilters() {
            state.advancedFilters = {
                genre: '',
                year: '',
                minRating: 0,
                tags: []
            };
            currentPage = 1;
            renderChannelList();
        }

        // EPG Functions
        function toggleEPG(channelId) {
            if (state.selectedEPGChannel === channelId && state.showEPG) {
                state.showEPG = false;
                state.selectedEPGChannel = null;
            } else {
                state.selectedEPGChannel = channelId;
                state.showEPG = true;
                loadEPGData(channelId);
            }
            render();
        }

        async function loadEPGData(channelId) {
            // Beispiel EPG-Daten (in Produktion von EPG-API laden)
            if (!state.epgData[channelId]) {
                const now = new Date();
                state.epgData[channelId] = [
                    {
                        start: new Date(now.getTime() - 60 * 60 * 1000),
                        end: new Date(now.getTime() + 30 * 60 * 1000),
                        title: 'Aktuelle Sendung',
                        description: 'Laufende Sendung im Programm'
                    },
                    {
                        start: new Date(now.getTime() + 30 * 60 * 1000),
                        end: new Date(now.getTime() + 120 * 60 * 1000),
                        title: 'N√§chste Sendung',
                        description: 'Kommende Sendung im Programm'
                    }
                ];
            }
        }

        function getEPGForChannel(channelId) {
            return state.epgData[channelId] || [];
        }

        function getCurrentProgram(channelId) {
            const epg = getEPGForChannel(channelId);
            const now = new Date();
            return epg.find(program => program.start <= now && program.end > now);
        }

        // Audio & Subtitle Functions
        function detectAudioTracks() {
            const video = document.getElementById('videoPlayer');
            if (!video) return;
            
            state.audioTracks = [];
            if (video.audioTracks && video.audioTracks.length > 0) {
                for (let i = 0; i < video.audioTracks.length; i++) {
                    state.audioTracks.push({
                        id: i,
                        label: video.audioTracks[i].label || `Audio ${i + 1}`,
                        language: video.audioTracks[i].language || 'unknown'
                    });
                }
            }
        }

        function selectAudioTrack(trackId) {
            const video = document.getElementById('videoPlayer');
            if (!video || !video.audioTracks) return;
            
            for (let i = 0; i < video.audioTracks.length; i++) {
                video.audioTracks[i].enabled = (i === trackId);
            }
            state.currentAudioTrack = trackId;
            renderVideoPlayer();
        }

        function selectSubtitleTrack(trackId) {
            const video = document.getElementById('videoPlayer');
            if (!video) return;
            
            // Alle Textspuren deaktivieren
            for (let i = 0; i < video.textTracks.length; i++) {
                video.textTracks[i].mode = 'hidden';
            }
            
            // Gew√§hlte Spur aktivieren
            if (trackId >= 0 && trackId < video.textTracks.length) {
                video.textTracks[trackId].mode = 'showing';
            }
            
            state.currentSubtitleTrack = trackId;
            renderVideoPlayer();
        }

        function uploadSubtitleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const video = document.getElementById('videoPlayer');
                if (!video) return;
                
                const track = document.createElement('track');
                track.kind = 'subtitles';
                track.label = file.name;
                track.srclang = 'de';
                track.src = URL.createObjectURL(file);
                
                video.appendChild(track);
                state.subtitleTracks.push({
                    id: video.textTracks.length - 1,
                    label: file.name
                });
                
                state.showSubtitleUpload = false;
                render();
            };
            reader.readAsText(file);
        }

        // Statistics Functions
        function trackView(itemId) {
            if (!state.statistics[itemId]) {
                state.statistics[itemId] = {
                    viewCount: 0,
                    totalWatchTime: 0,
                    lastViewed: null
                };
            }
            
            state.statistics[itemId].viewCount++;
            state.statistics[itemId].lastViewed = new Date().toISOString();
            safeLocalStorageSet('statistics', JSON.stringify(state.statistics));
            saveCurrentUserData(); // Auto-save f√ºr eingeloggten Benutzer
        }

        function trackWatchTime(itemId, seconds) {
            if (!state.statistics[itemId]) {
                state.statistics[itemId] = {
                    viewCount: 0,
                    totalWatchTime: 0,
                    lastViewed: null
                };
            }
            
            state.statistics[itemId].totalWatchTime += seconds;
            safeLocalStorageSet('statistics', JSON.stringify(state.statistics));
            saveCurrentUserData(); // Auto-save f√ºr eingeloggten Benutzer
        }

        function getTopWatchedItems(limit = 10) {
            const items = [...state.channels, ...state.movies, ...state.series];
            return items
                .filter(item => state.statistics[item.id])
                .sort((a, b) => {
                    const statA = state.statistics[a.id];
                    const statB = state.statistics[b.id];
                    return (statB.totalWatchTime || 0) - (statA.totalWatchTime || 0);
                })
                .slice(0, limit);
        }

        function getTotalWatchTime() {
            let total = 0;
            for (const itemId in state.statistics) {
                total += state.statistics[itemId].totalWatchTime || 0;
            }
            return total;
        }

        function toggleStatistics() {
            state.showStatistics = !state.showStatistics;
            render();
        }

        // Recommendation System
        function generateRecommendations() {
            const topWatched = getTopWatchedItems(5);
            if (topWatched.length === 0) {
                state.recommendations = [];
                return;
            }
            
            // Kategorien der meist geschauten Items
            const watchedCategories = [...new Set(topWatched.map(item => item.category))];
            
            // Finde √§hnliche Items
            const allItems = [...state.movies, ...state.series];
            const recommended = allItems
                .filter(item => {
                    // Nicht bereits angeschaut
                    const stat = state.statistics[item.id];
                    if (stat && stat.totalWatchTime > 60) return false;
                    
                    // Gleiche Kategorie
                    return watchedCategories.includes(item.category);
                })
                .sort(() => Math.random() - 0.5) // Zuf√§llige Sortierung
                .slice(0, 8);
            
            state.recommendations = recommended;
        }

        // ============================================
        // PHASE 5: USER MANAGEMENT & PARENTAL CONTROLS
        // ============================================
        
        // User Management Functions
        function createUser(name, avatar, isPinProtected = false, pin = '') {
            const userId = 'user_' + Date.now();
            const newUser = {
                id: userId,
                name: name,
                avatar: avatar, // emoji or image
                isPinProtected: isPinProtected,
                pin: pin, // Stored as plain text for demo (use hashing in production!)
                isKidsProfile: false,
                maxAgeRating: 18,
                dailyTimeLimit: 0, // 0 = unlimited, otherwise in minutes
                favorites: [],
                watchlist: [],
                watchProgress: {},
                ratings: {},
                tags: {},
                statistics: {},
                theme: 'dark',
                createdAt: new Date().toISOString()
            };
            
            state.users.push(newUser);
            safeLocalStorageSet('users', JSON.stringify(state.users));
            return newUser;
        }
        
        function deleteUser(userId) {
            state.users = state.users.filter(u => u.id !== userId);
            safeLocalStorageSet('users', JSON.stringify(state.users));
            
            // If current user was deleted, logout
            if (state.currentUser && state.currentUser.id === userId) {
                logoutUser();
            }
        }
        
        function updateUser(userId, updates) {
            const userIndex = state.users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                state.users[userIndex] = { ...state.users[userIndex], ...updates };
                safeLocalStorageSet('users', JSON.stringify(state.users));
                
                // Update current user if it's the one being updated
                if (state.currentUser && state.currentUser.id === userId) {
                    state.currentUser = state.users[userIndex];
                    safeLocalStorageSet('currentUser', JSON.stringify(state.currentUser));
                }
            }
        }
        
        function loginUser(userId, pin = null) {
            const user = state.users.find(u => u.id === userId);
            if (!user) return false;
            
            // Check PIN if protected
            if (user.isPinProtected) {
                if (pin !== user.pin) {
                    alert('Falscher PIN!');
                    return false;
                }
            }
            
            // Load user data
            state.currentUser = user;
            safeLocalStorageSet('currentUser', JSON.stringify(user));
            
            // Apply user preferences
            state.favorites = user.favorites || [];
            state.watchlist = user.watchlist || [];
            state.watchProgress = user.watchProgress || {};
            state.ratings = user.ratings || {};
            state.tags = user.tags || {};
            state.statistics = user.statistics || {};
            state.theme = user.theme || 'dark';
            
            // Update allTags from user's tags
            const userTags = new Set();
            Object.values(state.tags).forEach(tagArray => {
                tagArray.forEach(tag => userTags.add(tag));
            });
            state.allTags = Array.from(userTags);
            
            state.showUserLogin = false;
            state.showUserManager = false;
            
            applyTheme();
            render();
            return true;
        }
        
        function logoutUser() {
            // Save current user data before logout
            if (state.currentUser) {
                updateUser(state.currentUser.id, {
                    favorites: state.favorites,
                    watchlist: state.watchlist,
                    watchProgress: state.watchProgress,
                    ratings: state.ratings,
                    tags: state.tags,
                    statistics: state.statistics,
                    theme: state.theme
                });
            }
            
            state.currentUser = null;
            localStorage.removeItem('currentUser');
            
            // Reset to defaults
            state.favorites = [];
            state.watchlist = [];
            state.watchProgress = {};
            state.ratings = {};
            state.tags = {};
            state.statistics = {};
            state.theme = 'dark';
            
            state.showUserLogin = true;
            applyTheme();
            render();
        }
        
        function toggleUserManager() {
            state.showUserManager = !state.showUserManager;
            render();
        }
        
        function toggleUserLogin() {
            state.showUserLogin = !state.showUserLogin;
            render();
        }
        
        // Load user data on startup
        function loadCurrentUserData() {
            if (!state.currentUser) return;
            
            // Find user in users array to get latest data
            const user = state.users.find(u => u.id === state.currentUser.id);
            if (!user) {
                console.warn('Current user not found in users array, logging out');
                logoutUser();
                return;
            }
            
            // Update currentUser with latest data
            state.currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            // Apply user preferences
            state.favorites = user.favorites || [];
            state.watchlist = user.watchlist || [];
            state.watchProgress = user.watchProgress || {};
            state.ratings = user.ratings || {};
            state.tags = user.tags || {};
            state.statistics = user.statistics || {};
            state.theme = user.theme || 'dark';
            
            // Extract all tags from user's tags
            const userTags = new Set();
            Object.values(state.tags).forEach(tagArray => {
                tagArray.forEach(tag => userTags.add(tag));
            });
            state.allTags = Array.from(userTags);
            
            console.log('‚úì User data loaded:', user.name);
            console.log('  - Favorites:', state.favorites.length);
            console.log('  - Watchlist:', state.watchlist.length);
            console.log('  - Statistics:', Object.keys(state.statistics).length);
            console.log('  - Ratings:', Object.keys(state.ratings).length);
        }
        
        // Auto-save user data to localStorage
        function saveCurrentUserData() {
            if (!state.currentUser) return;
            
            updateUser(state.currentUser.id, {
                favorites: state.favorites,
                watchlist: state.watchlist,
                watchProgress: state.watchProgress,
                ratings: state.ratings,
                tags: state.tags,
                statistics: state.statistics,
                theme: state.theme
            });
        }
        
        // Parental Control Functions
        function enableParentalControl(pin) {
            if (!pin || pin.length < 4) {
                alert('PIN muss mindestens 4 Zeichen lang sein!');
                return false;
            }
            
            state.parentalControlEnabled = true;
            state.parentalControlPIN = pin;
            safeLocalStorageSet('parentalControlEnabled', 'true');
            safeLocalStorageSet('parentalControlPIN', pin);
            return true;
        }
        
        function disableParentalControl(pin) {
            if (pin !== state.parentalControlPIN) {
                alert('Falscher PIN!');
                return false;
            }
            
            state.parentalControlEnabled = false;
            safeLocalStorageSet('parentalControlEnabled', 'false');
            return true;
        }
        
        function checkParentalControl(item) {
            if (!state.parentalControlEnabled) return true;
            if (!state.currentUser) return true;
            
            // Check age rating
            const itemAge = item.ageRating || 0;
            const userMaxAge = state.currentUser.maxAgeRating || 18;
            
            if (itemAge > userMaxAge) {
                return false; // Blocked
            }
            
            // Check time limit
            if (state.currentUser.dailyTimeLimit > 0) {
                const todayKey = new Date().toDateString();
                const userStats = state.statistics[state.currentUser.id] || {};
                const todayTime = userStats[todayKey] || 0;
                
                if (todayTime >= state.currentUser.dailyTimeLimit * 60) {
                    return false; // Time limit exceeded
                }
            }
            
            return true;
        }
        
        // Cloud Sync Functions (Import/Export)
        function exportUserData() {
            const exportData = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                users: state.users,
                playlists: state.playlists,
                settings: {
                    theme: state.theme,
                    autoPlayNext: state.autoPlayNext,
                    parentalControl: {
                        enabled: state.parentalControlEnabled,
                        pin: state.parentalControlPIN
                    }
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `iptv-player-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            state.lastSyncTime = new Date().toISOString();
            alert('‚úÖ Backup downloaded successfully!');
        }
        
        function importUserData(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate format
                    if (!data.version || !data.users) {
                        alert('‚ö†Ô∏è Invalid backup format!');
                        return;
                    }
                    
                    // Confirm import
                    if (!confirm('‚ö†Ô∏è This will overwrite all current user data. Continue?')) {
                        return;
                    }
                    
                    // Import data
                    state.users = data.users || [];
                    state.playlists = data.playlists || [];
                    
                    if (data.settings) {
                        state.theme = data.settings.theme || 'dark';
                        state.autoPlayNext = data.settings.autoPlayNext || false;
                        
                        if (data.settings.parentalControl) {
                            state.parentalControlEnabled = data.settings.parentalControl.enabled || false;
                            state.parentalControlPIN = data.settings.parentalControl.pin || '';
                        }
                    }
                    
                    // Save to localStorage - mit sicherer Funktion
                    safeLocalStorageSet('users', JSON.stringify(state.users));
                    safeLocalStorageSet('playlists', JSON.stringify(state.playlists));
                    safeLocalStorageSet('theme', state.theme);
                    safeLocalStorageSet('autoPlayNext', String(state.autoPlayNext));
                    safeLocalStorageSet('parentalControlEnabled', String(state.parentalControlEnabled));
                    safeLocalStorageSet('parentalControlPIN', state.parentalControlPIN);
                    
                    state.lastSyncTime = new Date().toISOString();
                    
                    alert('‚úÖ Backup imported successfully! Page will reload...');
                    location.reload();
                } catch (error) {
                    console.error('Import error:', error);
                    alert('‚ùå Import error: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // Chromecast/AirPlay Functions
        function initCastAPI() {
            // Check for Google Cast API
            if (window.chrome && window.chrome.cast) {
                state.castAvailable = true;
                console.log('‚úì Chromecast API available');
            }
            
            // Check for AirPlay
            const video = document.getElementById('videoPlayer');
            if (video && video.webkitShowPlaybackTargetPicker) {
                state.castAvailable = true;
                console.log('‚úì AirPlay available');
            }
        }
        
        function startCasting() {
            const video = document.getElementById('videoPlayer');
            if (!video) return;
            
            // Try AirPlay first
            if (video.webkitShowPlaybackTargetPicker) {
                video.webkitShowPlaybackTargetPicker();
                return;
            }
            
            // Try Chromecast
            if (window.chrome && window.chrome.cast && window.chrome.cast.isAvailable) {
                const session = window.chrome.cast.requestSession(
                    (s) => {
                        state.castConnected = true;
                        state.castDevice = s.receiver.friendlyName;
                        console.log('‚úì Connected to', s.receiver.friendlyName);
                        render();
                    },
                    (error) => {
                        console.error('Cast error:', error);
                        alert('‚ùå Error connecting to Cast device');
                    }
                );
            } else {
                alert('‚ÑπÔ∏è No Cast devices available. Please install the Google Cast Extension.');
            }
        }
        
        function stopCasting() {
            if (window.chrome && window.chrome.cast) {
                const session = window.chrome.cast.getCurrentSession();
                if (session) {
                    session.stop(() => {
                        state.castConnected = false;
                        state.castDevice = null;
                        render();
                    }, (error) => {
                        console.error('Stop cast error:', error);
                    });
                }
            }
        }
        
        // Helper functions for User Management UI
        function showNewUserDialog() {
            const name = prompt('Username:');
            if (!name) return;
            
            const avatarOptions = ['üë§', 'üë®', 'üë©', 'üë¶', 'üëß', 'üßí', 'üë∂', 'üê∂', 'üê±', 'ü¶ä', 'üêº', 'üê®', 'ü¶Å', 'üêØ', 'ü¶Ñ'];
            const avatar = prompt(`Choose avatar:\n${avatarOptions.join(' ')}\n\nEnter emoji:`);
            
            const isPinProtected = confirm('Protect with PIN?');
            let pin = '';
            if (isPinProtected) {
                pin = prompt('Enter PIN (at least 4 characters):');
                if (!pin || pin.length < 4) {
                    alert('PIN must be at least 4 characters long!');
                    return;
                }
            }
            
            const isKidsProfile = confirm('Is this a kids profile?');
            
            const newUser = createUser(name, avatar || 'üë§', isPinProtected, pin);
            
            if (isKidsProfile) {
                updateUser(newUser.id, {
                    isKidsProfile: true,
                    maxAgeRating: 12,
                    dailyTimeLimit: 120 // 2 hours
                });
            }
            
            render();
        }



        // Load M3U from URL
        async function loadM3UFromURL(url, name = '', silent = false) {
            // CORS-Proxy-Optionen (mehrere Fallbacks)
            const corsProxies = [
                '', // Zuerst direkter Versuch ohne Proxy
                'https://corsproxy.io/?', // CORS Proxy 1
                'https://api.allorigins.win/raw?url=', // CORS Proxy 2
                'https://cors-anywhere.herokuapp.com/', // CORS Proxy 3 (limitiert, braucht Request)
            ];
            
            let lastError = null;
            
            for (let i = 0; i < corsProxies.length; i++) {
                const proxy = corsProxies[i];
                const fetchUrl = proxy + encodeURIComponent(url);
                const displayUrl = proxy ? `Proxy ${i}` : 'Direkt';
                
                try {
                    console.log(`üîÑ Versuche ${displayUrl}: ${proxy ? 'mit Proxy' : 'ohne Proxy'}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 Sekunden Timeout
                    
                    const response = await fetch(fetchUrl, {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/x-mpegURL, application/vnd.apple.mpegurl, text/plain, */*'
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const content = await response.text();
                    
                    // Validiere, dass es eine M3U-Datei ist
                    if (!content.includes('#EXTINF') && !content.includes('#EXTM3U')) {
                        throw new Error('Keine g√ºltige M3U-Datei (fehlende #EXTINF Tags)');
                    }
                    
                    console.log(`‚úÖ Erfolgreich geladen mit ${displayUrl}`);
                    
                    const parsed = parseM3U(content);
                    
                    // Erstelle eine neue Playlist
                    const playlistId = Date.now().toString();
                    const playlist = {
                        id: playlistId,
                        name: name || url,
                        url: url,
                        addedDate: new Date().toISOString(),
                        channelCount: parsed.channels.length,
                        movieCount: parsed.movies.length,
                        seriesCount: Object.keys(parsed.seriesMap || {}).length
                    };
                    
                    // Speichere Playlist-Daten NUR im RAM (nicht localStorage - zu gro√ü!)
                    state.playlistData[playlistId] = {
                        channels: parsed.channels,
                        movies: parsed.movies,
                        series: parsed.series,
                        seriesMap: parsed.seriesMap || {}
                    };
                    
                    // F√ºge zur Playlist-Liste hinzu (pr√ºfe ob URL schon existiert)
                    const existingIndex = state.playlists.findIndex(p => p.url === url);
                    if (existingIndex >= 0) {
                        // Aktualisiere bestehende Playlist
                        const oldId = state.playlists[existingIndex].id;
                        delete state.playlistData[oldId];
                        state.playlists[existingIndex] = playlist;
                    } else {
                        // Neue Playlist hinzuf√ºgen
                        state.playlists.push(playlist);
                    }
                    
                    // Aktualisiere Kan√§le/Filme/Serien aus allen Playlists
                    reloadAllPlaylistData();
                    
                    // Speichere NUR die Playlist-Metadaten (URLs, nicht die kompletten Daten!)
                    if (!safeLocalStorageSet('playlists', JSON.stringify(state.playlists))) {
                        console.warn('‚ö†Ô∏è Konnte Playlists nicht speichern - versuche alte Daten zu l√∂schen');
                        // Versuche alte Daten zu l√∂schen
                        localStorage.removeItem('playlistData'); // Alte Version aufr√§umen
                        // Versuche erneut
                        safeLocalStorageSet('playlists', JSON.stringify(state.playlists));
                    }
                    
                    // Entferne Lade-Toast
                    hideLoadingToast();
                    
                    if (!silent) {
                        const seriesGroupCount = Object.keys(parsed.seriesMap || {}).length;
                        alert(`‚úÖ Playlist loaded successfully!\n\nüì∫ ${parsed.channels.length} Live TV Channels\nüé¨ ${parsed.movies.length} Movies\nüì∫ ${seriesGroupCount} Series with ${parsed.series.length} Episodes`);
                    }
                    state.showUrlDialog = false;
                    render(); // Voller Render f√ºr Dialog-Schlie√üung n√∂tig
                    return; // Erfolg! Beende Funktion
                    
                } catch (error) {
                    lastError = error;
                    console.warn(`‚ùå ${displayUrl} fehlgeschlagen:`, error.message);
                    
                    // Bei Timeout oder AbortError n√§chsten Proxy versuchen
                    if (error.name === 'AbortError') {
                        console.log('‚è±Ô∏è Timeout - versuche n√§chste Methode...');
                    }
                    
                    // Wenn es der letzte Versuch war, zeige Fehler
                    if (i === corsProxies.length - 1) {
                        console.error('‚úó Alle Lade-Methoden fehlgeschlagen');
                        
                        // Entferne Lade-Toast
                        hideLoadingToast();
                        
                        if (!silent) {
                            const errorDetails = lastError.message || 'Unknown error';
                            alert(`‚ùå Error loading playlist\n\n` +
                                `Error: ${errorDetails}\n\n` +
                                `Possible solutions:\n` +
                                `1Ô∏è‚É£ Download and upload M3U file manually\n` +
                                `2Ô∏è‚É£ Check your internet connection\n` +
                                `3Ô∏è‚É£ Contact your IPTV provider\n` +
                                `4Ô∏è‚É£ Server might be offline or overloaded (502 Bad Gateway)\n\n` +
                                `Tip: Try again later!`);
                        }
                    }
                    
                    // Warte kurz bevor n√§chster Versuch
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
        }

        // Lade alle Playlist-Daten neu (aus gespeicherten Daten)
        function reloadAllPlaylistData() {
            state.channels = [];
            state.movies = [];
            state.series = [];
            state.seriesGroups = {};
            
            // Kombiniere alle Playlists
            for (const playlistId in state.playlistData) {
                const data = state.playlistData[playlistId];
                if (data) {
                    state.channels = [...state.channels, ...data.channels];
                    state.movies = [...state.movies, ...data.movies];
                    state.series = [...state.series, ...data.series];
                    
                    // Kombiniere seriesMap (gruppierte Serien)
                    if (data.seriesMap) {
                        for (const seriesName in data.seriesMap) {
                            if (!state.seriesGroups[seriesName]) {
                                state.seriesGroups[seriesName] = data.seriesMap[seriesName];
                            } else {
                                // Merge seasons wenn Serie schon existiert
                                for (const season in data.seriesMap[seriesName].seasons) {
                                    if (!state.seriesGroups[seriesName].seasons[season]) {
                                        state.seriesGroups[seriesName].seasons[season] = data.seriesMap[seriesName].seasons[season];
                                    } else {
                                        state.seriesGroups[seriesName].seasons[season] = [
                                            ...state.seriesGroups[seriesName].seasons[season],
                                            ...data.seriesMap[seriesName].seasons[season]
                                        ];
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Debug Output
            console.log('üìä Data loaded:', {
                channels: state.channels.length,
                movies: state.movies.length,
                series: state.series.length,
                seriesGroups: Object.keys(state.seriesGroups).length
            });
            
            // Clean invalid favorites after loading
            cleanupFavorites();
        }

        // Delete playlist
        function deletePlaylist(id) {
            if (!confirm('Really delete playlist?')) return;
            
            // Entferne Playlist-Daten aus RAM
            delete state.playlistData[id];
            
            // Entferne aus Playlist-Liste
            state.playlists = state.playlists.filter(p => p.id !== id);
            
            // Aktualisiere localStorage (nur Metadaten)
            safeLocalStorageSet('playlists', JSON.stringify(state.playlists));
            
            // Reload all channels
            reloadAllPlaylistData();
            
            render();
        }

        // Reload playlist
        async function reloadPlaylist(url) {
            await loadM3UFromURL(url, '', true);
        }

        // Switch tab
        function switchTab(tab) {
            // Nur wechseln, wenn es ein anderer Tab ist
            if (state.selectedTab === tab) return;
            
            state.selectedTab = tab;
            if (tab === 'favorites') {
                state.selectedCategory = 'All Favorites';
            } else {
                state.selectedCategory = tab === 'live' ? 'All Channels' : (tab === 'movies' ? 'All Movies' : 'All Series');
            }
            currentPage = 1; // Reset pagination
            itemRenderCache.clear(); // Clear cache for new tab
            
            // Alle Updates in einem Frame f√ºr bessere Performance
            requestAnimationFrame(() => {
                renderTabs();
                renderCategoryFilter();
                renderChannelList();
                // Video-Player nur resetten, nicht neu rendern (spart Zeit)
                const container = document.getElementById('videoPlayerContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                                <svg class="w-20 h-20 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                                <p class="text-xl text-gray-400">${tab === 'live' ? 'Select a channel' : (tab === 'movies' ? 'Select a movie' : 'Select a series')}</p>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // Show URL dialog
        function showUrlDialog() {
            state.showUrlDialog = true;
            render();
        }

        // Show Xtream dialog
        function showXtreamDialog() {
            state.showXtreamDialog = true;
            render();
        }

        // Show playlist manager
        function showPlaylistManager() {
            state.showPlaylistManager = !state.showPlaylistManager;
            render();
        }

        // Handle URL submit
        function handleUrlSubmit() {
            const urlInput = document.getElementById('m3uUrlInput');
            const nameInput = document.getElementById('playlistName');
            const url = urlInput.value.trim();
            const name = nameInput.value.trim();
            
            if (!url) {
                alert('‚ùå Bitte geben Sie eine URL ein');
                return;
            }
            
            // URL-Validierung
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert('‚ùå Bitte geben Sie eine g√ºltige HTTP(S)-URL ein\n\nBeispiel: https://example.com/playlist.m3u');
                return;
            }
            
            // Zus√§tzliche URL-Format-Pr√ºfung
            try {
                const urlObj = new URL(url);
                if (!urlObj.protocol || !urlObj.hostname) {
                    throw new Error('Ung√ºltige URL-Struktur');
                }
            } catch (e) {
                alert('‚ùå Ung√ºltige URL-Format\n\nBitte √ºberpr√ºfen Sie die URL und versuchen Sie es erneut.');
                console.error('URL-Validierung fehlgeschlagen:', e);
                return;
            }
            
            // Show loading animation
            showLoadingToast('Loading Playlist... Please wait.');
            
            loadM3UFromURL(url, name);
        }
        
        // Zeige Lade-Toast
        function showLoadingToast(message) {
            // Entferne alten Toast falls vorhanden
            const existingToast = document.getElementById('loadingToast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.id = 'loadingToast';
            toast.className = 'fixed top-20 right-4 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-slide-in flex items-center gap-3';
            toast.innerHTML = `
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
        }
        
        // Entferne Lade-Toast
        function hideLoadingToast() {
            const toast = document.getElementById('loadingToast');
            if (toast) {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }
        }

        // Handle Xtream API submit
        async function handleXtreamSubmit() {
            const server = document.getElementById('xtreamServer').value.trim();
            const username = document.getElementById('xtreamUsername').value.trim();
            const password = document.getElementById('xtreamPassword').value.trim();
            
            if (!server || !username || !password) {
                alert('‚ùå Bitte f√ºllen Sie alle Felder aus');
                return;
            }
            
            // Server-URL Validierung
            if (!server.startsWith('http://') && !server.startsWith('https://')) {
                alert('‚ùå Server-URL muss mit http:// oder https:// beginnen\n\nBeispiel: http://server.com:8080');
                return;
            }
            
            // Validiere URL-Format
            try {
                new URL(server);
            } catch (e) {
                alert('‚ùå Ung√ºltige Server-URL\n\nBitte √ºberpr√ºfen Sie die URL und versuchen Sie es erneut.');
                console.error('Server-URL Validierung fehlgeschlagen:', e);
                return;
            }
            
            // Entferne trailing slash von Server URL
            const serverUrl = server.replace(/\/$/, '');
            
            // Generiere M3U URL aus Xtream API Daten
            const m3uUrl = `${serverUrl}/get.php?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&type=m3u_plus&output=ts`;
            
            // Lade die Playlist
            const playlistName = `Xtream - ${username}`;
            await loadM3UFromURL(m3uUrl, playlistName);
            
            state.showXtreamDialog = false;
        }

        // Partial render functions f√ºr bessere Performance
        function renderTabs() {
            const tabsContainer = document.getElementById('tabsContainer');
            if (!tabsContainer) {
                console.warn('tabsContainer nicht gefunden');
                return;
            }
            
            const seriesCount = Object.keys(state.seriesGroups || {}).length;
            
            tabsContainer.innerHTML = `
                <button
                    onclick="switchTab('live')"
                    class="px-4 py-2 rounded-md transition ${state.selectedTab === 'live' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:text-white'}"
                >
                    üì∫ Live TV (${state.channels.length})
                </button>
                <button
                    onclick="switchTab('movies')"
                    class="px-4 py-2 rounded-md transition ${state.selectedTab === 'movies' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:text-white'}"
                >
                    üé¨ Movies (${state.movies.length})
                </button>
                <button
                    onclick="switchTab('series')"
                    class="px-4 py-2 rounded-md transition ${state.selectedTab === 'series' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:text-white'}"
                >
                    üì∫ Series (${seriesCount})
                </button>
                <button
                    onclick="switchTab('favorites')"
                    class="px-4 py-2 rounded-md transition ${state.selectedTab === 'favorites' ? 'bg-yellow-600 text-white' : 'text-gray-300 hover:text-white'}"
                >
                    ‚≠ê Favorites (${state.favorites.length})
                </button>
            `;
        }

        function renderCategoryFilter() {
            const categorySelect = document.getElementById('categorySelect');
            if (!categorySelect) {
                console.warn('categorySelect not found');
                return;
            }
            
            const categories = getCategories();
            categorySelect.innerHTML = categories.map(cat => `
                <option value="${cat}" ${state.selectedCategory === cat ? 'selected' : ''}>
                    ${cat}
                </option>
            `).join('');
        }

        function renderChannelList() {
            // Verhindere mehrfache Renders im gleichen Frame
            if (renderScheduled) return;
            renderScheduled = true;
            
            requestAnimationFrame(() => {
                renderScheduled = false; // Reset f√ºr n√§chsten Render
                
                const channelListContainer = document.getElementById('channelListContainer');
                const statsContainer = document.getElementById('statsContainer');
                if (!channelListContainer) {
                    return;
                }
                
                const allFilteredChannels = getFilteredChannels(false);
                const filteredChannels = getFilteredChannels(true); // Mit Pagination
                const activeItem = state.currentChannel || state.currentMovie;
                const hasMore = allFilteredChannels.length > filteredChannels.length;
                
                if (allFilteredChannels.length === 0) {
                    const emptyMessage = state.selectedTab === 'favorites' 
                        ? '<div class="p-8 text-center text-gray-400"><svg class="w-20 h-20 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg><p class="text-lg">No favorites yet</p><p class="text-sm mt-2">Click the ‚≠ê star on channels, movies or series</p></div>'
                        : `<div class="p-8 text-center text-gray-400"><p>No ${state.selectedTab === 'live' ? 'channels' : (state.selectedTab === 'movies' ? 'movies' : 'series')} found</p><p class="text-sm mt-2">Load an M3U file</p></div>`;
                    channelListContainer.innerHTML = emptyMessage;
                } else {
                    // Fragment f√ºr bessere Performance
                    const itemsHtml = filteredChannels.map(item => renderChannelItem(item, activeItem)).join('');
                    
                    // Grid oder List Layout je nach viewMode
                    const gridClass = state.viewMode === 'grid' 
                        ? (state.selectedTab !== 'live' ? 'grid grid-cols-2 gap-2' : '')
                        : 'flex flex-col';
                    
                    channelListContainer.innerHTML = `
                        <div class="p-2 ${gridClass}">
                            ${itemsHtml}
                        </div>
                        ${hasMore ? `
                            <div class="p-4 text-center">
                                <button 
                                    onclick="currentPage++; renderChannelList();"
                                    class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg transition"
                                >
                                    Load More (${allFilteredChannels.length - filteredChannels.length} more)
                                </button>
                            </div>
                        ` : ''}
                    `;
                    
                    // Setup Scroll-Event f√ºr Lazy Loading
                    setupInfiniteScroll(channelListContainer, allFilteredChannels.length);
                }
                
                if (statsContainer) {
                    statsContainer.innerHTML = `
                        <div class="flex justify-between text-sm text-gray-400">
                            <span>${allFilteredChannels.length} ${state.selectedTab === 'live' ? 'channels' : (state.selectedTab === 'movies' ? 'movies' : 'series')}</span>
                            <span>${state.favorites.length} favorites</span>
                        </div>
                        ${state.selectedTab === 'favorites' && state.favorites.length > 0 ? `
                            <button 
                                onclick="if(confirm('Delete all favorites?')) { state.favorites = []; localStorage.setItem('favorites', '[]'); renderTabs(); renderChannelList(); }"
                                class="w-full mt-2 bg-red-600/20 hover:bg-red-600/40 text-red-400 px-3 py-1.5 rounded text-xs transition"
                            >
                                Delete All Favorites
                            </button>
                        ` : ''}
                    `;
                }
            });
        }

        // Infinite Scroll Setup
        let scrollListener = null;
        function setupInfiniteScroll(container, totalItems) {
            // Entferne alten Listener vom vorherigen Container
            if (scrollListener && scrollListenerContainer) {
                scrollListenerContainer.removeEventListener('scroll', scrollListener);
                console.log('‚úì Alter Scroll-Listener entfernt');
            }
            
            // Speichere neue Container-Referenz
            scrollListenerContainer = container;
            
            scrollListener = debounce(() => {
                const scrollPercentage = (container.scrollTop + container.clientHeight) / container.scrollHeight;
                if (scrollPercentage > 0.8 && currentPage * ITEMS_PER_PAGE < totalItems) {
                    currentPage++;
                    renderChannelList();
                }
            }, 100);
            
            container.addEventListener('scroll', scrollListener);
        }

        // Cache f√ºr gerenderte Items - erh√∂htes Limit f√ºr bessere Performance
        const itemRenderCache = new Map();
        const MAX_CACHE_SIZE = 1000;
        
        function renderChannelItem(item, activeItem) {
            const isActive = activeItem?.id === item.id;
            const isFavorite = state.favorites.includes(item.id);
            const hasProgress = state.watchProgress[item.id];
            const rating = getAverageRating(item.id);
            const itemTags = getItemTags(item.id);
            const isInWatchlist = state.watchlist.includes(item.id);
            
            // Cache-Key erstellen (mit Rating und Tags)
            const cacheKey = `${item.id}-${isActive}-${isFavorite}-${state.selectedTab}-${hasProgress ? 'prog' : 'noprog'}-${rating}-${itemTags.length}-${isInWatchlist}`;
            if (itemRenderCache.has(cacheKey)) {
                return itemRenderCache.get(cacheKey);
            }
            
            // LRU Cache: Entferne √§lteste Eintr√§ge wenn zu gro√ü
            if (itemRenderCache.size >= MAX_CACHE_SIZE) {
                const firstKey = itemRenderCache.keys().next().value;
                itemRenderCache.delete(firstKey);
            }
            
            // Escape HTML in Namen f√ºr sichere Darstellung
            const safeName = escapeHtml(item.name);
            const safeCategory = escapeHtml(item.category);
            const validLogo = getValidImageUrl(item.logo);
            
            let html;
            if (state.selectedTab !== 'live') {
                // Berechne Fortschritt wenn vorhanden
                let progressPercent = 0;
                let progressText = '';
                if (hasProgress) {
                    progressPercent = Math.floor((hasProgress.currentTime / hasProgress.duration) * 100);
                    const minutes = Math.floor(hasProgress.currentTime / 60);
                    progressText = `${minutes} Min`;
                }
                
                // Spezielle Darstellung f√ºr Serien mit Staffeln/Folgen
                const isSeriesGroup = item.seriesData !== undefined;
                
                // Movie/Series Card
                html = `
                    <div onclick='selectChannel("${item.id}")' class="cursor-pointer transition hover:scale-105 group">
                        <div class="relative aspect-[2/3] bg-gray-700 rounded-lg overflow-hidden mb-2">
                            ${validLogo ? `
                                <img src="${escapeHtml(validLogo)}" alt="${safeName}" class="w-full h-full object-cover" 
                                     loading="lazy"
                                     onerror="markImageAsFailed('${escapeHtml(validLogo)}'); this.style.display='none'; this.parentElement.classList.add('flex', 'items-center', 'justify-center'); this.parentElement.innerHTML='<svg class=\\'w-16 h-16 text-gray-500\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path d=\\'M7 4v16M17 4v16M3 8h18M3 12h18M3 16h18\\'></path></svg>';" />
                            ` : `
                                <div class="w-full h-full flex items-center justify-center">
                                    <svg class="w-16 h-16 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M7 4v16M17 4v16M3 8h18M3 12h18M3 16h18"></path>
                                    </svg>
                                </div>
                            `}
                            ${isSeriesGroup ? `
                                <div class="absolute top-2 left-2 bg-purple-600 text-white text-xs px-2 py-1 rounded-full">
                                    üì∫ ${item.seasonCount} Season${item.seasonCount !== 1 ? 's' : ''} ‚Ä¢ ${item.episodeCount} Episodes
                                </div>
                            ` : hasProgress ? `
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-2">
                                    <div class="flex items-center gap-2 text-xs text-white mb-1">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                        </svg>
                                        <span>${progressText} ‚Ä¢ ${progressPercent}%</span>
                                    </div>
                                    <div class="w-full bg-gray-600 rounded-full h-1">
                                        <div class="bg-blue-500 h-1 rounded-full" style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                                <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                            </div>
                            ${!isSeriesGroup ? `
                            <button onclick="event.stopPropagation(); toggleFavorite('${item.id}');" 
                                    class="absolute top-2 right-2 p-2 bg-black/50 hover:bg-black/70 rounded-full transition z-10">
                                <svg class="w-4 h-4 ${isFavorite ? 'fill-yellow-400 text-yellow-400' : 'text-white'}" 
                                     fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); toggleWatchlist('${item.id}');" 
                                    class="absolute top-2 right-12 p-2 bg-black/50 hover:bg-black/70 rounded-full transition z-10"
                                    title="${state.watchlist.includes(item.id) ? 'Remove from Watchlist' : 'Add to Watchlist'}">
                                <svg class="w-4 h-4 ${state.watchlist.includes(item.id) ? 'text-blue-400 fill-blue-400' : 'text-white'}" 
                                     fill="${state.watchlist.includes(item.id) ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                </svg>
                            </button>
                            ` : ''}
                        </div>
                        <h3 class="font-semibold text-sm truncate px-1">${safeName}</h3>
                        <p class="text-xs text-gray-400 truncate px-1">${safeCategory}</p>
                        
                        ${!isSeriesGroup && state.selectedTab !== 'live' ? `
                        <!-- Rating Stars -->
                        <div class="flex gap-0.5 px-1 mt-1" onclick="event.stopPropagation();">
                            ${[1, 2, 3, 4, 5].map(star => `
                                <button onclick="rateItem('${item.id}', ${star})" class="hover:scale-125 transition">
                                    <svg class="w-3 h-3 ${star <= rating ? 'fill-yellow-400 text-yellow-400' : 'text-gray-500'}" 
                                         fill="${star <= rating ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                    </svg>
                                </button>
                            `).join('')}
                            ${rating > 0 ? `<span class="text-xs text-gray-400 ml-1">${rating.toFixed(1)}</span>` : ''}
                        </div>
                        
                        <!-- Tags -->
                        ${itemTags.length > 0 ? `
                        <div class="flex flex-wrap gap-1 px-1 mt-1">
                            ${itemTags.slice(0, 3).map(tag => `
                                <span class="text-xs bg-blue-600/30 text-blue-300 px-2 py-0.5 rounded-full">
                                    ${escapeHtml(tag)}
                                </span>
                            `).join('')}
                            ${itemTags.length > 3 ? `<span class="text-xs text-gray-500">+${itemTags.length - 3}</span>` : ''}
                        </div>
                        ` : ''}
                        ` : ''}
                    </div>
                `;
            } else {
                // Channel List Item
                html = `
                    <div onclick='selectChannel("${item.id}")' 
                         class="flex items-center gap-3 p-3 rounded-lg mb-2 cursor-pointer transition ${isActive ? 'bg-blue-600 text-white' : 'hover:bg-gray-700/50'}">
                        <div class="w-12 h-12 bg-gray-700 rounded-lg flex items-center justify-center flex-shrink-0 overflow-hidden">
                            ${validLogo ? `
                                <img src="${escapeHtml(validLogo)}" alt="${safeName}" class="w-full h-full object-cover" 
                                     loading="lazy"
                                     onerror="markImageAsFailed('${escapeHtml(validLogo)}'); this.style.display='none'; this.parentElement.innerHTML='<svg class=\\'w-6 h-6 text-gray-500\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path d=\\'M2 8.5a2.5 2.5 0 0 1 5 0v7a2.5 2.5 0 0 1-5 0v-7z\\'></path><path d=\\'M13 5.5a2.5 2.5 0 0 1 5 0v10a2.5 2.5 0 0 1-5 0v-10z\\'></path></svg>';" />
                            ` : `
                                <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M2 8.5a2.5 2.5 0 0 1 5 0v7a2.5 2.5 0 0 1-5 0v-7z"></path>
                                    <path d="M13 5.5a2.5 2.5 0 0 1 5 0v10a2.5 2.5 0 0 1-5 0v-10z"></path>
                                </svg>
                            `}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold truncate">${safeName}</h3>
                            <p class="text-sm text-gray-400 truncate">${safeCategory}</p>
                        </div>
                        <button onclick="event.stopPropagation(); toggleFavorite('${item.id}');" class="p-2 hover:bg-white/10 rounded-full transition">
                            <svg class="w-5 h-5 ${isFavorite ? 'fill-yellow-400 text-yellow-400' : 'text-gray-400'}" 
                                 fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                        </button>
                    </div>
                `;
            }
            
            // Cache the rendered HTML
            itemRenderCache.set(cacheKey, html);
            
            return html;
        }

        function updateVideoInfo() {
            const videoInfoContainer = document.getElementById('videoInfoContainer');
            const videoElement = document.getElementById('videoPlayer');
            
            // Video-Element sichtbar/unsichtbar machen (wenn vorhanden)
            if (videoElement) {
                const activeItem = state.currentChannel || state.currentMovie;
                if (activeItem) {
                    videoElement.classList.remove('hidden');
                } else {
                    videoElement.classList.add('hidden');
                }
            }
            
            // Video-Info nur aktualisieren, wenn Container existiert
            if (!videoInfoContainer) {
                // Container existiert nicht - das ist OK, wenn kein Kanal aktiv ist
                return;
            }
            
            const activeItem = state.currentChannel || state.currentMovie;
            if (activeItem && state.selectedTab === 'live') {
                videoInfoContainer.innerHTML = `
                    <h3 class="text-white font-semibold">${escapeHtml(activeItem.name)}</h3>
                    <p class="text-sm text-gray-300">${escapeHtml(activeItem.category)}</p>
                `;
            }
        }

        function renderVideoPlayer() {
            const container = document.getElementById('videoPlayerContainer');
            if (!container) {
                console.warn('videoPlayerContainer nicht gefunden');
                return;
            }
            
            const activeItem = state.currentChannel || state.currentMovie;
            
            if (!activeItem) {
                // No channel selected - show placeholder
                container.innerHTML = `
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <svg class="w-20 h-20 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            <p class="text-xl text-gray-400">${state.selectedTab === 'live' ? 'Select a channel' : (state.selectedTab === 'movies' ? 'Select a movie' : 'Select a series')}</p>
                        </div>
                    </div>
                `;
            } else {
                // Channel selected - show video player
                const showControls = state.selectedTab !== 'live';
                const safeName = escapeHtml(activeItem.name);
                const safeCategory = escapeHtml(activeItem.category);
                
                container.innerHTML = `
                    <!-- Video Element -->
                    <video
                        id="videoPlayer"
                        class="w-full h-full"
                        autoplay
                        playsinline
                        ${showControls ? 'controls' : ''}
                    ></video>
                    
                    <!-- Intro Skip Button -->
                    ${state.showIntroSkip && activeItem.type === 'series' ? `
                    <div class="absolute bottom-24 right-4 z-10">
                        <button
                            onclick="skipIntro()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-lg transition flex items-center gap-2 font-semibold animate-bounce"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                            </svg>
                            Skip Intro
                        </button>
                    </div>
                    ` : ''}
                    
                    <!-- EPG Panel (Electronic Program Guide for Live TV) -->
                    ${state.showEPG && state.selectedTab === 'live' && activeItem ? `
                    <div class="absolute bottom-20 left-4 right-4 bg-gray-900/95 backdrop-blur rounded-lg shadow-xl p-4 z-10 max-h-64 overflow-y-auto">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-white font-semibold flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                                Programm
                            </h3>
                            <button onclick="toggleEPG()" class="text-gray-400 hover:text-white">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        ${(() => {
                            const epgProgram = getEPGForChannel(activeItem.id);
                            const currentProgram = getCurrentProgram(activeItem.id);
                            if (!epgProgram || epgProgram.length === 0) {
                                return `<p class="text-gray-400 text-sm">Keine Programminformationen verf√ºgbar</p>`;
                            }
                            return `
                                <div class="space-y-2">
                                    ${epgProgram.slice(0, 5).map(program => {
                                        const isActive = currentProgram && currentProgram.title === program.title;
                                        return `
                                        <div class="p-3 rounded-lg ${isActive ? 'bg-blue-600' : 'bg-gray-800'} hover:bg-gray-700 transition">
                                            <div class="flex justify-between items-start mb-1">
                                                <h4 class="text-white font-medium ${isActive ? 'flex items-center gap-2' : ''}">
                                                    ${isActive ? '<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>' : ''}
                                                    ${program.title}
                                                </h4>
                                                <span class="text-xs text-gray-300">${program.start} - ${program.end}</span>
                                            </div>
                                            ${program.description ? `<p class="text-sm text-gray-300 line-clamp-2">${program.description}</p>` : ''}
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                        })()}
                    </div>
                    ` : ''}
                    
                    <!-- Controls Overlay (nur f√ºr Live TV) -->
                    ${state.selectedTab === 'live' ? `
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <button
                                    onclick="togglePlay()"
                                    class="p-2 hover:bg-white/20 rounded-full transition"
                                >
                                    ${state.isPlaying ? `
                                        <div class="w-6 h-6 flex items-center justify-center">
                                            <div class="flex gap-1">
                                                <div class="w-1.5 h-4 bg-white"></div>
                                                <div class="w-1.5 h-4 bg-white"></div>
                                            </div>
                                        </div>
                                    ` : `
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                        </svg>
                                    `}
                                </button>
                                
                                <button
                                    onclick="toggleMute()"
                                    class="p-2 hover:bg-white/20 rounded-full transition"
                                >
                                    ${state.isMuted ? `
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                            <line x1="23" x2="17" y1="9" y2="15"></line>
                                            <line x1="17" x2="23" y1="9" y2="15"></line>
                                        </svg>
                                    ` : `
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                        </svg>
                                    `}
                                </button>
                                
                                <!-- Playback Speed -->
                                <div class="relative group">
                                    <button class="p-2 hover:bg-white/20 rounded-full transition">
                                        <span class="text-sm font-semibold">${state.playbackSpeed}x</span>
                                    </button>
                                    <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-gray-900 rounded-lg shadow-lg p-2 hidden group-hover:block">
                                        <div class="flex flex-col gap-1">
                                            ${[0.5, 0.75, 1, 1.25, 1.5, 2].map(speed => `
                                                <button
                                                    onclick="changePlaybackSpeed(${speed})"
                                                    class="px-3 py-1 text-sm rounded hover:bg-white/20 transition ${state.playbackSpeed === speed ? 'bg-blue-600' : ''}"
                                                >
                                                    ${speed}x
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Picture-in-Picture -->
                                <button
                                    onclick="togglePictureInPicture()"
                                    class="p-2 hover:bg-white/20 rounded-full transition"
                                    title="Bild-in-Bild"
                                >
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M21 12V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6"></path>
                                        <rect width="8" height="6" x="13" y="13" rx="1"></rect>
                                    </svg>
                                </button>
                            </div>

                            <div class="flex-1 mx-4">
                                <div id="videoInfoContainer">
                                    <h3 class="text-white font-semibold">${safeName}</h3>
                                    <p class="text-sm text-gray-300">${safeCategory}</p>
                                </div>
                            </div>

                            <button
                                onclick="toggleFullscreen()"
                                class="p-2 hover:bg-white/20 rounded-full transition"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    ` : `
                    <!-- Info Bar for Movies/Series with Controls -->
                    <div class="absolute top-0 left-0 right-0 bg-gradient-to-b from-black/80 to-transparent p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-white font-semibold text-lg">${safeName}</h3>
                                <p class="text-sm text-gray-300">${safeCategory}</p>
                                ${activeItem.type === 'series' ? `
                                <div class="flex items-center gap-2 mt-2">
                                    <button
                                        onclick="toggleAutoPlay()"
                                        class="px-3 py-1 text-xs rounded-lg transition ${state.autoPlayNext ? 'bg-blue-600' : 'bg-black/50 hover:bg-black/70'}"
                                        title="${state.autoPlayNext ? 'Auto-Play deaktivieren' : 'Auto-Play aktivieren'}"
                                    >
                                        <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                                        </svg>
                                        Auto-Play ${state.autoPlayNext ? 'AN' : 'AUS'}
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <!-- Playback Speed -->
                                <div class="relative group">
                                    <button class="px-3 py-1 bg-black/50 hover:bg-black/70 rounded-lg transition">
                                        <span class="text-sm font-semibold">${state.playbackSpeed}x</span>
                                    </button>
                                    <div class="absolute top-full mt-2 right-0 bg-gray-900 rounded-lg shadow-lg p-2 hidden group-hover:block z-10">
                                        <div class="flex flex-col gap-1 min-w-[80px]">
                                            ${[0.5, 0.75, 1, 1.25, 1.5, 2].map(speed => `
                                                <button
                                                    onclick="changePlaybackSpeed(${speed})"
                                                    class="px-3 py-1 text-sm rounded hover:bg-white/20 transition text-left ${state.playbackSpeed === speed ? 'bg-blue-600' : ''}"
                                                >
                                                    ${speed}x
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Audio Track Selector -->
                                ${state.audioTracks.length > 1 ? `
                                <div class="relative group">
                                    <button class="p-2 bg-black/50 hover:bg-black/70 rounded-lg transition" title="Audio-Spur">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                                        </svg>
                                    </button>
                                    <div class="absolute top-full mt-2 right-0 bg-gray-900 rounded-lg shadow-lg p-2 hidden group-hover:block z-10 min-w-[150px]">
                                        ${state.audioTracks.map((track, index) => `
                                            <button
                                                onclick="selectAudioTrack(${index})"
                                                class="w-full px-3 py-2 text-sm rounded hover:bg-white/20 transition text-left ${state.selectedAudioTrack === index ? 'bg-blue-600' : ''}"
                                            >
                                                ${track.label || `Audio ${index + 1}`}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- Subtitle Track Selector -->
                                ${state.subtitleTracks.length > 0 ? `
                                <div class="relative group">
                                    <button class="p-2 bg-black/50 hover:bg-black/70 rounded-lg transition" title="Untertitel">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                                        </svg>
                                    </button>
                                    <div class="absolute top-full mt-2 right-0 bg-gray-900 rounded-lg shadow-lg p-2 hidden group-hover:block z-10 min-w-[150px]">
                                        <button
                                            onclick="selectSubtitleTrack(-1)"
                                            class="w-full px-3 py-2 text-sm rounded hover:bg-white/20 transition text-left ${state.selectedSubtitleTrack === -1 ? 'bg-blue-600' : ''}"
                                        >
                                            Aus
                                        </button>
                                        ${state.subtitleTracks.map((track, index) => `
                                            <button
                                                onclick="selectSubtitleTrack(${index})"
                                                class="w-full px-3 py-2 text-sm rounded hover:bg-white/20 transition text-left ${state.selectedSubtitleTrack === index ? 'bg-blue-600' : ''}"
                                            >
                                                ${track.label || `Untertitel ${index + 1}`}
                                            </button>
                                        `).join('')}
                                        <hr class="my-2 border-gray-700">
                                        <button
                                            onclick="document.getElementById('subtitleUpload').click()"
                                            class="w-full px-3 py-2 text-sm rounded hover:bg-white/20 transition text-left"
                                        >
                                            + Upload Subtitle
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="subtitleUpload" accept=".srt,.vtt" style="display:none" onchange="uploadSubtitleFile(event)">
                                ` : ''}
                                
                                <!-- EPG Button (nur f√ºr Live TV) -->
                                ${activeItem && activeItem.type === 'live' ? `
                                <button
                                    onclick="toggleEPG()"
                                    class="p-2 bg-black/50 hover:bg-black/70 rounded-lg transition ${state.showEPG ? 'bg-blue-600' : ''}"
                                    title="Programm"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                    </svg>
                                </button>
                                ` : ''}
                                
                                <!-- Picture-in-Picture -->
                                <button
                                    onclick="togglePictureInPicture()"
                                    class="p-2 bg-black/50 hover:bg-black/70 rounded-lg transition"
                                    title="Bild-in-Bild"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M21 12V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6"></path>
                                        <rect width="8" height="6" x="13" y="13" rx="1"></rect>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    `}
                `;
            }
        }

        // Render app
        function render() {
            const filteredChannels = getFilteredChannels();
            const categories = getCategories();
            const activeItem = state.currentChannel || state.currentMovie;

            document.getElementById('app').innerHTML = `
                <!-- Header -->
                <header class="bg-gray-800/80 backdrop-blur border-b border-gray-700 sticky top-0 z-50">
                    <div class="container mx-auto px-4 py-4">
                        <!-- First Row: Logo, Tabs, Search -->
                        <div class="flex items-center justify-between gap-4 flex-wrap mb-3">
                            <!-- Logo -->
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-600 p-2 rounded-lg">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <rect width="20" height="15" x="2" y="7" rx="2" ry="2"></rect>
                                        <polyline points="17 2 12 7 7 2"></polyline>
                                    </svg>
                                </div>
                                <div>
                                    <h1 class="text-xl font-bold">IPTV Player</h1>
                                    <p class="text-xs text-gray-400">Live TV & Movies</p>
                                </div>
                            </div>

                            <!-- Tabs -->
                            <div id="tabsContainer" class="flex gap-2 bg-gray-700/50 p-1 rounded-lg">
                                <!-- Wird durch renderTabs() gef√ºllt -->
                            </div>

                            <!-- Search -->
                            <div class="flex-1 max-w-md min-w-[200px]">
                                <div class="relative">
                                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <path d="m21 21-4.3-4.3"></path>
                                    </svg>
                                    <input
                                        type="text"
                                        placeholder="${state.selectedTab === 'favorites' ? 'Search favorites...' : (state.selectedTab === 'live' ? 'Search channel...' : (state.selectedTab === 'movies' ? 'Search movie...' : 'Search series...'))}"
                                        value="${state.searchQuery}"
                                        oninput="state.searchQuery = this.value; currentPage = 1; debounce(renderChannelList, 300)();"
                                        class="w-full bg-gray-700 text-white rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                                    />
                                </div>
                            </div>
                        </div>
                        
                        <!-- Second Row: Action Buttons -->
                        <div class="flex items-center justify-between gap-4 flex-wrap">
                            <!-- Left: Action Buttons -->
                            <div class="flex items-center gap-2">
                                <!-- Advanced Search Toggle (nur f√ºr Movies/Series) -->
                                ${state.selectedTab !== 'live' ? `
                                <button
                                    onclick="toggleAdvancedSearch()"
                                    class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg transition ${state.showAdvancedSearch ? 'ring-2 ring-blue-400' : ''}"
                                    title="Advanced Search"
                                >
                                    <svg class="w-4 h-4 ${state.showAdvancedSearch ? 'text-blue-400' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                    </svg>
                                </button>
                                ` : ''}
                                
                                <!-- Statistics Toggle (nur f√ºr Movies/Series) -->
                                ${state.selectedTab !== 'live' ? `
                                <button
                                    onclick="toggleStatistics()"
                                    class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg transition ${state.showStatistics ? 'ring-2 ring-green-400' : ''}"
                                    title="Statistics"
                                >
                                    <svg class="w-4 h-4 ${state.showStatistics ? 'text-green-400' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 00-2-2m0 0h2m-6 0h2m6 0v-4a2 2 0 012-2h2a2 2 0 012 2v4m0 0V5a2 2 0 00-2-2h-2a2 2 0 00-2 2v14a2 2 0 002 2h2a2 2 0 002-2z"></path>
                                    </svg>
                                </button>
                                ` : ''}

                                <!-- Theme Toggle -->
                                <button
                                    onclick="toggleTheme()"
                                    class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg transition"
                                    title="${state.theme === 'dark' ? 'Light Mode' : 'Dark Mode'}"
                                >
                                    ${state.theme === 'dark' ? `
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="4"></circle>
                                        <path d="M12 2v2"></path>
                                        <path d="M12 20v2"></path>
                                        <path d="m4.93 4.93 1.41 1.41"></path>
                                        <path d="m17.66 17.66 1.41 1.41"></path>
                                        <path d="M2 12h2"></path>
                                        <path d="M20 12h2"></path>
                                        <path d="m6.34 17.66-1.41 1.41"></path>
                                        <path d="m19.07 4.93-1.41 1.41"></path>
                                    </svg>
                                    ` : `
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                                    </svg>
                                    `}
                                </button>
                                
                                <!-- Language Switch -->
                                <button
                                    onclick="window.location.href='../de/'"
                                    class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition flex items-center gap-2"
                                    title="Zur deutschen Version wechseln"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                                    </svg>
                                    <span class="hidden md:inline text-sm">DE</span>
                                </button>
                                
                                <!-- Cast Button (Chromecast/AirPlay) -->
                                ${state.castAvailable ? `
                                <button
                                    onclick="${state.castConnected ? 'stopCasting()' : 'startCasting()'}"
                                    class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg transition ${state.castConnected ? 'ring-2 ring-blue-400' : ''}"
                                    title="${state.castConnected ? 'Stop Casting' : 'Cast to TV'}"
                                >
                                    <svg class="w-5 h-5 ${state.castConnected ? 'text-blue-400' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 18h12a2 2 0 002-2V6a2 2 0 00-2-2H4a2 2 0 00-2 2v5M2 18h4"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 14a4 4 0 004 4M2 10a8 8 0 018 8"></path>
                                    </svg>
                                </button>
                                ` : ''}
                                
                                <!-- User Profile Button -->
                                ${state.currentUser ? `
                                <button
                                    onclick="toggleUserManager()"
                                    class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition font-semibold"
                                    title="User Profile"
                                >
                                    <span class="text-xl">${state.currentUser.avatar || 'üë§'}</span>
                                    <span class="hidden md:inline">${state.currentUser.name}</span>
                                </button>
                                ` : `
                                <button
                                    onclick="toggleUserLogin()"
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition font-semibold"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    User
                                </button>
                                `}
                            </div>
                            <!-- End Left Action Buttons -->
                            
                            <!-- Right: Playlist Management Buttons -->
                            <div class="flex items-center gap-2">
                                <!-- M3U URL Button -->
                            <button
                                onclick="showUrlDialog()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition font-semibold"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                </svg>
                                M3U URL
                            </button>

                            <!-- Xtream API Button -->
                            <button
                                onclick="showXtreamDialog()"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition font-semibold"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                                </svg>
                                Xtream API
                            </button>

                            <!-- Playlist Manager Button -->
                            <button
                                onclick="showPlaylistManager()"
                                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition font-semibold"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M9 5H2v7h7V5z"></path>
                                    <path d="M22 5h-7v7h7V5z"></path>
                                    <path d="M9 18H2v7h7v-7z"></path>
                                    <path d="M22 18h-7v7h7v-7z"></path>
                                </svg>
                                Lists (${state.playlists.length})
                            </button>

                            <!-- PayPal Donation Button -->
                            <a
                                href="https://paypal.me/ebukyz58"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg flex items-center gap-2 transition font-semibold"
                                title="Donate via PayPal"
                            >
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
                                </svg>
                                Donate
                            </a>
                            
                            <input
                                id="fileInput"
                                type="file"
                                accept=".m3u,.m3u8"
                                onchange="handleFileUpload(event)"
                                class="hidden"
                            />
                        </div>
                    </div>
                </header>

                <!-- Main Content -->
                <main class="container mx-auto px-4 py-6">
                    <!-- Continue Watching Section -->
                    ${(() => {
                        const continueWatching = getContinueWatching();
                        if (continueWatching.length > 0 && (state.selectedTab === 'movies' || state.selectedTab === 'series')) {
                            return `
                            <div class="mb-6 bg-gray-800/50 rounded-lg p-4">
                                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Continue Watching
                                </h2>
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                    ${continueWatching.slice(0, 8).map(item => {
                                        const progress = item.progress;
                                        const percent = Math.floor((progress.currentTime / progress.duration) * 100);
                                        const validLogo = getValidImageUrl(item.logo);
                                        return `
                                            <div onclick='selectChannel("${item.id}")' class="cursor-pointer group">
                                                <div class="relative bg-gray-700 rounded-lg overflow-hidden aspect-video">
                                                    ${validLogo ? `
                                                        <img src="${escapeHtml(validLogo)}" class="w-full h-full object-cover group-hover:scale-110 transition-transform" 
                                                             onerror="this.style.display='none';" />
                                                    ` : ''}
                                                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex items-end p-2">
                                                        <div class="w-full">
                                                            <div class="text-xs font-semibold mb-1 truncate">${escapeHtml(item.name)}</div>
                                                            <div class="w-full bg-gray-600 rounded-full h-1">
                                                                <div class="bg-blue-500 h-1 rounded-full" style="width: ${percent}%"></div>
                                                            </div>
                                                            <div class="text-xs text-gray-400 mt-1">${percent}%</div>
                                                        </div>
                                                    </div>
                                                    <div class="absolute top-2 right-2 bg-black/70 px-2 py-1 rounded text-xs">
                                                        ${Math.floor(progress.currentTime / 60)}:${(Math.floor(progress.currentTime % 60)).toString().padStart(2, '0')}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            `;
                        }
                        return '';
                    })()}
                    
                    <!-- Recommendations Section -->
                    ${(() => {
                        const recommendations = state.recommendations;
                        if (recommendations.length > 0 && (state.selectedTab === 'movies' || state.selectedTab === 'series')) {
                            return `
                            <div class="mb-6 bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-lg p-4 border border-purple-500/30">
                                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                                    <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                    </svg>
                                    Recommended for You
                                    <span class="text-xs text-gray-400 font-normal">Based on your viewing history</span>
                                </h2>
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                    ${recommendations.slice(0, 10).map(item => {
                                        const validLogo = getValidImageUrl(item.logo);
                                        const avgRating = getAverageRating(item.id);
                                        const isInWatchlist = state.watchlist.includes(item.id);
                                        return `
                                            <div class="cursor-pointer group relative" onclick='selectChannel("${item.id}")'>
                                                <div class="relative bg-gray-700 rounded-lg overflow-hidden aspect-[2/3]">
                                                    ${validLogo ? `
                                                        <img src="${escapeHtml(validLogo)}" class="w-full h-full object-cover group-hover:scale-110 transition-transform" 
                                                             onerror="this.style.display='none';" />
                                                    ` : ''}
                                                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <div class="absolute bottom-0 left-0 right-0 p-2">
                                                            <div class="text-xs font-semibold line-clamp-2">${escapeHtml(item.name)}</div>
                                                        </div>
                                                    </div>
                                                    ${avgRating > 0 ? `
                                                    <div class="absolute top-2 left-2 bg-black/80 px-2 py-1 rounded-full text-xs flex items-center gap-1">
                                                        <svg class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                                        </svg>
                                                        ${avgRating.toFixed(1)}
                                                    </div>
                                                    ` : ''}
                                                    ${isInWatchlist ? `
                                                    <div class="absolute top-2 right-2 bg-blue-600 rounded-full p-1">
                                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                                                        </svg>
                                                    </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            `;
                        }
                        return '';
                    })()}
                    
                    <!-- Statistics Dashboard -->
                    ${state.showStatistics && (state.selectedTab === 'movies' || state.selectedTab === 'series') ? `
                    <div class="mb-6 bg-gray-800/50 rounded-lg p-4 border border-green-600/50">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold flex items-center gap-2">
                                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 00-2-2m0 0h2m-6 0h2m6 0v-4a2 2 0 012-2h2a2 2 0 012 2v4m0 0V5a2 2 0 00-2-2h-2a2 2 0 00-2 2v14a2 2 0 002 2h2a2 2 0 002-2z"></path>
                                </svg>
                                My Statistics
                            </h2>
                            <button onclick="toggleStatistics()" class="text-gray-400 hover:text-white">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        ${(() => {
                            const totalTime = getTotalWatchTime();
                            const topWatched = getTopWatchedItems(5);
                            const hours = Math.floor(totalTime / 3600);
                            const minutes = Math.floor((totalTime % 3600) / 60);
                            
                            return `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <!-- Total Watch Time -->
                                <div class="bg-green-900/30 rounded-lg p-4 border border-green-600/30">
                                    <div class="text-sm text-gray-400 mb-1">Total Watch Time</div>
                                    <div class="text-2xl font-bold text-green-400">${hours}h ${minutes}m</div>
                                </div>
                                
                                <!-- Total Items Watched -->
                                <div class="bg-blue-900/30 rounded-lg p-4 border border-blue-600/30">
                                    <div class="text-sm text-gray-400 mb-1">Watched Content</div>
                                    <div class="text-2xl font-bold text-blue-400">${Object.keys(state.statistics).length}</div>
                                </div>
                                
                                <!-- Watchlist Count -->
                                <div class="bg-purple-900/30 rounded-lg p-4 border border-purple-600/30">
                                    <div class="text-sm text-gray-400 mb-1">Watchlist</div>
                                    <div class="text-2xl font-bold text-purple-400">${state.watchlist.length}</div>
                                </div>
                            </div>
                            
                            <!-- Top Watched Items -->
                            ${topWatched.length > 0 ? `
                            <div class="bg-gray-900/50 rounded-lg p-4">
                                <h3 class="text-sm font-semibold mb-3 text-gray-300">Most Watched</h3>
                                <div class="space-y-2">
                                    ${topWatched.map((stat, index) => {
                                        const item = [...state.channels, ...state.movies].find(i => i.id === stat.id);
                                        if (!item) return '';
                                        const watchHours = Math.floor(stat.watchTime / 3600);
                                        const watchMinutes = Math.floor((stat.watchTime % 3600) / 60);
                                        return `
                                        <div class="flex items-center justify-between p-2 bg-gray-800 rounded hover:bg-gray-700 transition cursor-pointer" onclick='selectChannel("${item.id}")'>
                                            <div class="flex items-center gap-3">
                                                <span class="text-lg font-bold text-gray-500 w-6">${index + 1}</span>
                                                <div>
                                                    <div class="text-sm font-medium">${escapeHtml(item.name)}</div>
                                                    <div class="text-xs text-gray-400">${stat.viewCount} views</div>
                                                </div>
                                            </div>
                                            <div class="text-sm text-gray-400">${watchHours > 0 ? `${watchHours}h ` : ''}${watchMinutes}m</div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            ` : ''}
                            `;
                        })()}
                    </div>
                    ` : ''}
                    
                    <!-- Advanced Search Panel -->
                    ${state.showAdvancedSearch && state.selectedTab !== 'live' ? `
                    <div class="mb-6 bg-gray-800/50 rounded-lg p-4 border border-blue-600/50">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                </svg>
                                Advanced Filters
                            </h2>
                            <button onclick="toggleAdvancedSearch()" class="text-gray-400 hover:text-white">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <!-- Genre Filter -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Genre/Category</label>
                                <input
                                    type="text"
                                    value="${state.advancedFilters.genre}"
                                    oninput="state.advancedFilters.genre = this.value; applyAdvancedFilters();"
                                    placeholder="e.g. Action, Drama"
                                    class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600"
                                />
                            </div>
                            
                            <!-- Year Filter -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Year</label>
                                <input
                                    type="text"
                                    value="${state.advancedFilters.year}"
                                    oninput="state.advancedFilters.year = this.value; applyAdvancedFilters();"
                                    placeholder="e.g. 2024"
                                    class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600"
                                />
                            </div>
                            
                            <!-- Rating Filter -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Min. Rating</label>
                                <select
                                    onchange="state.advancedFilters.minRating = parseFloat(this.value); applyAdvancedFilters();"
                                    class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600"
                                >
                                    <option value="0" ${state.advancedFilters.minRating === 0 ? 'selected' : ''}>All</option>
                                    <option value="1" ${state.advancedFilters.minRating === 1 ? 'selected' : ''}>‚≠ê 1+</option>
                                    <option value="2" ${state.advancedFilters.minRating === 2 ? 'selected' : ''}>‚≠ê‚≠ê 2+</option>
                                    <option value="3" ${state.advancedFilters.minRating === 3 ? 'selected' : ''}>‚≠ê‚≠ê‚≠ê 3+</option>
                                    <option value="4" ${state.advancedFilters.minRating === 4 ? 'selected' : ''}>‚≠ê‚≠ê‚≠ê‚≠ê 4+</option>
                                    <option value="5" ${state.advancedFilters.minRating === 5 ? 'selected' : ''}>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5</option>
                                </select>
                            </div>
                            
                            <!-- Tags Filter -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Tags</label>
                                <select
                                    multiple
                                    onchange="state.advancedFilters.tags = Array.from(this.selectedOptions).map(o => o.value); applyAdvancedFilters();"
                                    class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600"
                                    style="height: 38px;"
                                >
                                    ${state.allTags.map(tag => `
                                        <option value="${escapeHtml(tag)}" ${state.advancedFilters.tags.includes(tag) ? 'selected' : ''}>
                                            ${escapeHtml(tag)}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button
                                onclick="resetAdvancedFilters();"
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm transition"
                            >
                                Reset Filters
                            </button>
                            <button
                                onclick="toggleAdvancedSearch();"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition"
                            >
                                Done
                            </button>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Video Player -->
                        <div class="lg:col-span-2">
                            <div class="bg-black rounded-lg overflow-hidden shadow-2xl">
                                <div id="videoPlayerContainer" class="relative aspect-video bg-gradient-to-br from-gray-900 to-black">
                                    <!-- Wird durch renderVideoPlayer() gef√ºllt -->
                                </div>
                            </div>
                        </div>
                                        
                                        <!-- Controls Overlay (nur f√ºr Live TV) -->
                                        ${state.selectedTab === 'live' && activeItem ? `
                                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-2">
                                                    <button
                                                        onclick="togglePlay()"
                                                        class="p-2 hover:bg-white/20 rounded-full transition"
                                                    >
                                                        ${state.isPlaying ? `
                                                            <div class="w-6 h-6 flex items-center justify-center">
                                                                <div class="flex gap-1">
                                                                    <div class="w-1.5 h-4 bg-white"></div>
                                                                    <div class="w-1.5 h-4 bg-white"></div>
                                                                </div>
                                                            </div>
                                                        ` : `
                                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                                            </svg>
                                                         `}
                                                    </button>
                                                    
                                                    <button
                                                        onclick="toggleMute()"
                                                        class="p-2 hover:bg-white/20 rounded-full transition"
                                                    >
                                                        ${state.isMuted ? `
                                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                                                <line x1="23" x2="17" y1="9" y2="15"></line>
                                                                <line x1="17" x2="23" y1="9" y2="15"></line>
                                                            </svg>
                                                        ` : `
                                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                                            </svg>
                                                        `}
                                                    </button>
                                                </div>

                                                <div class="flex-1 mx-4">
                                                    <div id="videoInfoContainer">
                                                        <h3 class="text-white font-semibold">${activeItem.name}</h3>
                                                        <p class="text-sm text-gray-300">${activeItem.category}</p>
                                                    </div>
                                                </div>

                                                <button
                                                    onclick="toggleFullscreen()"
                                                    class="p-2 hover:bg-white/20 rounded-full transition"
                                                >
                                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        ` : ''}
                                        
                                        <!-- Info Bar for Movies/Series -->
                                        ${state.selectedTab !== 'live' && activeItem ? `
                                        <div class="absolute top-0 left-0 right-0 bg-gradient-to-b from-black/80 to-transparent p-4">
                                            <h3 class="text-white font-semibold text-lg">${activeItem.name}</h3>
                                            <p class="text-sm text-gray-300">${activeItem.category}</p>
                                        </div>
                                        ` : ''}

                        <!-- Channel List -->
                        <div class="bg-gray-800/50 backdrop-blur rounded-lg shadow-2xl flex flex-col" style="height: calc(100vh - 200px);">
                            <!-- Category Filter -->
                            <div class="p-4 border-b border-gray-700">
                                ${state.selectedTab === 'favorites' ? `
                                    <!-- Favoriten Type Filter -->
                                    <div class="flex gap-2">
                                        <button
                                            onclick="state.favoriteFilter = 'all'; currentPage = 1; renderChannelList();"
                                            class="flex-1 px-3 py-2 rounded-lg transition ${state.favoriteFilter === 'all' ? 'bg-yellow-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}"
                                        >
                                            All
                                        </button>
                                        <button
                                            onclick="state.favoriteFilter = 'live'; currentPage = 1; renderChannelList();"
                                            class="flex-1 px-3 py-2 rounded-lg transition ${state.favoriteFilter === 'live' ? 'bg-yellow-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}"
                                        >
                                            üì∫ TV
                                        </button>
                                        <button
                                            onclick="state.favoriteFilter = 'movies'; currentPage = 1; renderChannelList();"
                                            class="flex-1 px-3 py-2 rounded-lg transition ${state.favoriteFilter === 'movies' ? 'bg-yellow-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}"
                                        >
                                            üé¨ Movies
                                        </button>
                                        <button
                                            onclick="state.favoriteFilter = 'series'; currentPage = 1; renderChannelList();"
                                            class="flex-1 px-3 py-2 rounded-lg transition ${state.favoriteFilter === 'series' ? 'bg-yellow-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}"
                                        >
                                            üì∫ Series
                                        </button>
                                    </div>
                                ` : `
                                    <!-- Kategorie-Filter f√ºr andere Tabs -->
                                    <select
                                        id="categorySelect"
                                        onchange="state.selectedCategory = this.value; currentPage = 1; renderChannelList();"
                                        class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                                    >
                                        <!-- Wird durch renderCategoryFilter() gef√ºllt -->
                                    </select>
                                `}
                            </div>

                            <!-- Sortierung & View Mode Controls -->
                            <div class="p-4 border-b border-gray-700 flex gap-2 items-center">
                                <!-- Sortierung -->
                                <select
                                    onchange="changeSortOrder(this.value);"
                                    class="flex-1 bg-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600"
                                >
                                    <option value="default" ${state.sortBy === 'default' ? 'selected' : ''}>Default</option>
                                    <option value="name-asc" ${state.sortBy === 'name-asc' ? 'selected' : ''}>A-Z</option>
                                    <option value="name-desc" ${state.sortBy === 'name-desc' ? 'selected' : ''}>Z-A</option>
                                    <option value="date-desc" ${state.sortBy === 'date-desc' ? 'selected' : ''}>Newest</option>
                                    <option value="date-asc" ${state.sortBy === 'date-asc' ? 'selected' : ''}>Oldest</option>
                                </select>

                                <!-- View Mode Toggle -->
                                <button
                                    onclick="toggleViewMode();"
                                    class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg transition"
                                    title="${state.viewMode === 'grid' ? 'List View' : 'Grid View'}"
                                >
                                    ${state.viewMode === 'grid' ? `
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <line x1="8" x2="21" y1="6" y2="6"></line>
                                        <line x1="8" x2="21" y1="12" y2="12"></line>
                                        <line x1="8" x2="21" y1="18" y2="18"></line>
                                        <line x1="3" x2="3.01" y1="6" y2="6"></line>
                                        <line x1="3" x2="3.01" y1="12" y2="12"></line>
                                        <line x1="3" x2="3.01" y1="18" y2="18"></line>
                                    </svg>
                                    ` : `
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <rect width="7" height="7" x="3" y="3" rx="1"></rect>
                                        <rect width="7" height="7" x="14" y="3" rx="1"></rect>
                                        <rect width="7" height="7" x="14" y="14" rx="1"></rect>
                                        <rect width="7" height="7" x="3" y="14" rx="1"></rect>
                                    </svg>
                                    `}
                                </button>
                            </div>

                            <!-- Channel/Movie/Series List -->
                            <div id="channelListContainer" class="flex-1 overflow-y-auto scrollbar-hide">
                                <!-- Wird durch renderChannelList() gef√ºllt -->
                            </div>

                            <!-- Stats -->
                            <div class="p-4 border-t border-gray-700">
                                <div id="statsContainer">
                                    <!-- Wird durch renderChannelList() gef√ºllt -->
                                </div>
                            </div>
                        </div>
                    </div>
                </main>

                <!-- URL Dialog -->
                ${state.showUrlDialog ? `
                    <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onclick="state.showUrlDialog = false; render();">
                        <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full" onclick="event.stopPropagation();">
                            <h2 class="text-2xl font-bold mb-4">Load M3U Playlist from URL</h2>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Playlist Name (optional)</label>
                                    <input
                                        id="playlistName"
                                        type="text"
                                        placeholder="e.g. My IPTV List"
                                        class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                                    />
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2">M3U URL</label>
                                    <input
                                        id="m3uUrlInput"
                                        type="url"
                                        placeholder="https://example.com/playlist.m3u8"
                                        class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                                    />
                                </div>

                                <div class="bg-yellow-900/30 border border-yellow-600 rounded-lg p-3 text-sm">
                                    <p class="font-semibold mb-1">‚ö†Ô∏è CORS Notice:</p>
                                    <p class="text-gray-300">If the URL doesn't load, the server may not support direct browser requests.</p>
                                </div>

                                <div class="flex gap-3 justify-end">
                                    <button
                                        onclick="state.showUrlDialog = false; render();"
                                        class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onclick="handleUrlSubmit()"
                                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition font-semibold"
                                    >
                                        Load
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Xtream API Dialog -->
                ${state.showXtreamDialog ? `
                    <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onclick="state.showXtreamDialog = false; render();">
                        <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full" onclick="event.stopPropagation();">
                            <h2 class="text-2xl font-bold mb-4">Xtream API Connection</h2>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Server URL</label>
                                    <input
                                        id="xtreamServer"
                                        type="url"
                                        placeholder="http://server.com:port"
                                        class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                    />
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2">Username</label>
                                    <input
                                        id="xtreamUsername"
                                        type="text"
                                        placeholder="Username"
                                        class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2">Password</label>
                                    <input
                                        id="xtreamPassword"
                                        type="password"
                                        placeholder="Password"
                                        class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                    />
                                </div>

                                <div class="bg-blue-900/30 border border-blue-600 rounded-lg p-3 text-sm">
                                    <p class="font-semibold mb-1">‚ÑπÔ∏è Xtream API Info:</p>
                                    <p class="text-gray-300">Enter your Xtream Codes server details. The M3U playlist will be generated automatically.</p>
                                </div>

                                <div class="flex gap-3 justify-end">
                                    <button
                                        onclick="state.showXtreamDialog = false; render();"
                                        class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onclick="handleXtreamSubmit()"
                                        class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition font-semibold"
                                    >
                                        Connect
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- User Login/Selection Dialog -->
                ${state.showUserLogin || (!state.currentUser && state.users.length > 0) ? `
                    <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
                        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full p-8 border border-purple-500/30" onclick="event.stopPropagation();">
                            <h2 class="text-3xl font-bold mb-8 text-center bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                                Who's watching?
                            </h2>
                            
                            <!-- User Profiles Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                                ${state.users.map(user => `
                                    <div
                                        onclick="loginUser('${user.id}', ${user.isPinProtected ? `prompt('Enter PIN:')` : 'null'})"
                                        class="cursor-pointer group"
                                    >
                                        <div class="bg-gradient-to-br from-purple-600/20 to-blue-600/20 hover:from-purple-600/40 hover:to-blue-600/40 rounded-2xl p-6 transition-all transform hover:scale-105 border border-purple-500/30 hover:border-purple-500/60">
                                            <div class="text-6xl text-center mb-4">${user.avatar || 'üë§'}</div>
                                            <h3 class="text-center font-semibold text-lg truncate">${escapeHtml(user.name)}</h3>
                                            ${user.isKidsProfile ? `
                                                <div class="text-center text-xs text-blue-400 mt-2 flex items-center justify-center gap-1">
                                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    Kids Profile
                                                </div>
                                            ` : ''}
                                            ${user.isPinProtected ? `
                                                <div class="text-center text-xs text-yellow-400 mt-2 flex items-center justify-center gap-1">
                                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    PIN-protected
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                                
                                <!-- Add New User -->
                                <div
                                    onclick="showNewUserDialog()"
                                    class="cursor-pointer group"
                                >
                                    <div class="bg-gray-800/50 hover:bg-gray-700/50 rounded-2xl p-6 transition-all transform hover:scale-105 border-2 border-dashed border-gray-600 hover:border-gray-500 flex flex-col items-center justify-center h-full">
                                        <svg class="w-12 h-12 text-gray-500 group-hover:text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        <span class="text-gray-400 group-hover:text-gray-300 font-medium">Profil hinzuf√ºgen</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Guest Mode Button -->
                            <div class="text-center">
                                <button
                                    onclick="state.showUserLogin = false; render();"
                                    class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition"
                                >
                                    Als Gast fortfahren
                                </button>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <!-- User Manager Dialog -->
                ${state.showUserManager && state.currentUser ? `
                    <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onclick="state.showUserManager = false; render();">
                        <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-8 border border-purple-500/30" onclick="event.stopPropagation();">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold flex items-center gap-3">
                                    <span class="text-4xl">${state.currentUser.avatar || 'üë§'}</span>
                                    ${escapeHtml(state.currentUser.name)}
                                </h2>
                                <button onclick="state.showUserManager = false; render();" class="text-gray-400 hover:text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- User Stats -->
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="bg-blue-900/30 rounded-lg p-4 border border-blue-600/30">
                                    <div class="text-sm text-gray-400 mb-1">Favoriten</div>
                                    <div class="text-2xl font-bold text-blue-400">${state.favorites.length}</div>
                                </div>
                                <div class="bg-purple-900/30 rounded-lg p-4 border border-purple-600/30">
                                    <div class="text-sm text-gray-400 mb-1">Watchlist</div>
                                    <div class="text-2xl font-bold text-purple-400">${state.watchlist.length}</div>
                                </div>
                                <div class="bg-green-900/30 rounded-lg p-4 border border-green-600/30">
                                    <div class="text-sm text-gray-400 mb-1">Ratings</div>
                                    <div class="text-2xl font-bold text-green-400">${Object.keys(state.ratings).length}</div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="space-y-3">
                                <!-- Export/Import -->
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <h3 class="font-semibold mb-3 flex items-center gap-2">
                                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                        </svg>
                                        Backup & Sync
                                    </h3>
                                    <div class="flex gap-3">
                                        <button
                                            onclick="exportUserData()"
                                            class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition flex items-center justify-center gap-2"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                            </svg>
                                            Download Backup
                                        </button>
                                        <button
                                            onclick="document.getElementById('importFile').click()"
                                            class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition flex items-center justify-center gap-2"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                            </svg>
                                            Import Backup
                                        </button>
                                        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importUserData(this.files[0])">
                                    </div>
                                    ${state.lastSyncTime ? `
                                        <p class="text-xs text-gray-400 mt-2">Last Backup: ${new Date(state.lastSyncTime).toLocaleString('en-US')}</p>
                                    ` : ''}
                                </div>
                                
                                <!-- Logout -->
                                <button
                                    onclick="logoutUser()"
                                    class="w-full px-4 py-3 bg-red-900/30 hover:bg-red-900/50 text-red-400 rounded-lg transition flex items-center gap-3 border border-red-600/30"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Series Detail Dialog -->
                ${state.showSeriesDetail && state.selectedSeries ? `
                    <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onclick="closeSeriesDetail();">
                        <div class="bg-gray-800 rounded-lg max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col" onclick="event.stopPropagation();">
                            <!-- Header -->
                            <div class="p-6 border-b border-gray-700 flex items-start justify-between">
                                <div>
                                    <h2 class="text-3xl font-bold mb-2">${escapeHtml(state.selectedSeries.name)}</h2>
                                    <p class="text-gray-400">${escapeHtml(state.selectedSeries.category)}</p>
                                    <p class="text-sm text-gray-500 mt-2">
                                        ${Object.keys(state.selectedSeries.seasons).length} Season${Object.keys(state.selectedSeries.seasons).length !== 1 ? 's' : ''} ‚Ä¢ 
                                        ${Object.values(state.selectedSeries.seasons).reduce((sum, eps) => sum + eps.length, 0)} Episodes
                                    </p>
                                </div>
                                <button
                                    onclick="closeSeriesDetail();"
                                    class="p-2 hover:bg-gray-700 rounded-full transition"
                                >
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Season Selector -->
                            <div class="p-4 border-b border-gray-700 bg-gray-900/50">
                                <div class="flex gap-2 overflow-x-auto scrollbar-hide">
                                    ${Object.keys(state.selectedSeries.seasons).sort((a, b) => parseInt(a) - parseInt(b)).map(season => `
                                        <button
                                            onclick="selectSeason(${season});"
                                            class="px-4 py-2 rounded-lg whitespace-nowrap transition ${state.selectedSeason === parseInt(season) ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'}"
                                        >
                                            Season ${season}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Episodes List -->
                            <div class="flex-1 overflow-y-auto p-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    ${state.selectedSeason && state.selectedSeries.seasons[state.selectedSeason] ? 
                                        state.selectedSeries.seasons[state.selectedSeason]
                                            .sort((a, b) => a.episode - b.episode)
                                            .map(episode => {
                                                const hasProgress = state.watchProgress[episode.id];
                                                let progressPercent = 0;
                                                if (hasProgress) {
                                                    progressPercent = Math.floor((hasProgress.currentTime / hasProgress.duration) * 100);
                                                }
                                                return `
                                                    <div 
                                                        onclick="playEpisode('${episode.id}');"
                                                        class="bg-gray-700/50 hover:bg-gray-700 rounded-lg p-4 cursor-pointer transition group"
                                                    >
                                                        <div class="flex gap-4">
                                                            <div class="flex-shrink-0 w-32 h-20 bg-gray-600 rounded-lg flex items-center justify-center relative overflow-hidden">
                                                                ${episode.logo ? `
                                                                    <img src="${escapeHtml(episode.logo)}" alt="" class="w-full h-full object-cover" loading="lazy" />
                                                                ` : `
                                                                    <div class="text-2xl font-bold text-gray-400">${episode.episode}</div>
                                                                `}
                                                                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                                                                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                                                    </svg>
                                                                </div>
                                                                ${hasProgress ? `
                                                                    <div class="absolute bottom-0 left-0 right-0 bg-gray-900 h-1">
                                                                        <div class="bg-blue-500 h-1" style="width: ${progressPercent}%"></div>
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                            <div class="flex-1 min-w-0">
                                                                <div class="flex items-start justify-between gap-2">
                                                                    <h3 class="font-semibold">
                                                                        ${episode.episode}. ${escapeHtml(episode.episodeTitle)}
                                                                    </h3>
                                                                    ${hasProgress ? `
                                                                        <span class="text-xs text-blue-400 whitespace-nowrap">${progressPercent}%</span>
                                                                    ` : ''}
                                                                </div>
                                                                <p class="text-sm text-gray-400 mt-1">Episode ${episode.episode}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')
                                    : '<p class="text-gray-400 text-center py-8">No episodes found</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Playlist Manager -->
                ${state.showPlaylistManager ? `
                    <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onclick="state.showPlaylistManager = false; render();">
                        <div class="bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation();">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">Playlist Management</h2>
                                <button
                                    onclick="state.showPlaylistManager = false; render();"
                                    class="p-2 hover:bg-gray-700 rounded-full"
                                >
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            ${state.playlists.length === 0 ? `
                                <div class="text-center py-12 text-gray-400">
                                    <svg class="w-20 h-20 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M9 5H2v7h7V5z"></path>
                                        <path d="M22 5h-7v7h7V5z"></path>
                                        <path d="M9 18H2v7h7v-7z"></path>
                                        <path d="M22 18h-7v7h7v-7z"></path>
                                    </svg>
                                    <p class="text-lg">No playlists saved</p>
                                    <p class="text-sm mt-2">Load an M3U file via URL or upload</p>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${state.playlists.map(playlist => `
                                        <div class="bg-gray-700/50 rounded-lg p-4 hover:bg-gray-700 transition">
                                            <div class="flex items-start justify-between gap-4">
                                                <div class="flex-1 min-w-0">
                                                    <h3 class="font-semibold text-lg truncate">${playlist.name}</h3>
                                                    <p class="text-sm text-gray-400 truncate">${playlist.url}</p>
                                                    <div class="flex gap-4 mt-2 text-sm text-gray-300">
                                                        <span>üì∫ ${playlist.channelCount} Channels</span>
                                                        <span>üé¨ ${playlist.movieCount} Movies</span>
                                                        <span>üì∫ ${playlist.seriesCount} Series</span>
                                                    </div>
                                                    <p class="text-xs text-gray-500 mt-1">
                                                        Added: ${new Date(playlist.addedDate).toLocaleDateString('en-US')}
                                                    </p>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button
                                                        onclick="reloadPlaylist('${playlist.url}')"
                                                        class="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition"
                                                        title="Reload"
                                                    >
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path d="M21 12a9 9 0 11-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                            <path d="M21 3v5h-5"></path>
                                                        </svg>
                                                    </button>
                                                    <button
                                                        onclick="deletePlaylist(${playlist.id})"
                                                        class="p-2 bg-red-600 hover:bg-red-700 rounded-lg transition"
                                                        title="Delete"
                                                    >
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path d="M3 6h18"></path>
                                                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                ` : ''}
            `;

            // Initial render der Teil-Komponenten nach DOM-Update
            setTimeout(() => {
                renderTabs();
                renderCategoryFilter();
                renderChannelList();
                renderVideoPlayer();
                
                // Reload video if current item is still selected (NACH renderVideoPlayer!)
                const activeItem = state.currentChannel || state.currentMovie;
                if (activeItem) {
                    setTimeout(() => loadVideo(activeItem), 150);
                }
            }, 0);
        }

        // Initialisiere Playlists beim Start
        async function initializePlaylists() {
            console.log('Loading saved playlists...');
            
            // R√§ume alte localStorage-Daten auf
            localStorage.removeItem('playlistData');
            
            if (state.playlists.length === 0) {
                console.log('No saved playlists found.');
                return;
            }
            
            console.log(`${state.playlists.length} Playlist(s) found, loading data...`);
            state.isLoadingPlaylists = true;
            
            // Lade alle Playlists parallel
            const loadPromises = state.playlists.map(async (playlist) => {
                try {
                    if (playlist.url.startsWith('data:')) {
                        // Lokale Datei aus data-URL dekodieren
                        const base64Data = playlist.url.split(',')[1];
                        const content = decodeURIComponent(escape(atob(base64Data)));
                        const parsed = parseM3U(content);
                        
                        state.playlistData[playlist.id] = {
                            channels: parsed.channels,
                            movies: parsed.movies,
                            series: parsed.series,
                            seriesMap: parsed.seriesMap || {}
                        };
                        console.log(`‚úì Lokale Datei geladen: ${playlist.name}`);
                    } else if (playlist.url.startsWith('http')) {
                        // URL-basierte Playlist
                        const response = await fetch(playlist.url);
                        if (!response.ok) throw new Error('Fetch failed');
                        
                        const content = await response.text();
                        const parsed = parseM3U(content);
                        
                        state.playlistData[playlist.id] = {
                            channels: parsed.channels,
                            movies: parsed.movies,
                            series: parsed.series,
                            seriesMap: parsed.seriesMap || {}
                        };
                        console.log(`‚úì URL geladen: ${playlist.name}`);
                    } else {
                        console.warn(`‚ö† Temporary file skipped: ${playlist.name}`);
                    }
                } catch (error) {
                    console.error(`‚úó Fehler beim Laden von ${playlist.name}:`, error.message);
                }
            });
            
            await Promise.all(loadPromises);
            
            // Aktualisiere Kan√§le/Filme/Serien
            reloadAllPlaylistData();
            
            state.isLoadingPlaylists = false;
            console.log('All playlists loaded!');
        }

        // Initial render
        console.log('Initializing IPTV Player...');
        try {
            // Theme sofort anwenden
            applyTheme();
            
            // Show loading screen
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
                        <p class="text-xl text-gray-300">Loading IPTV Player...</p>
                        <p class="text-sm text-gray-500 mt-2">Loading playlists</p>
                    </div>
                </div>
            `;
            
            // Lade gespeicherte Playlists (async)
            initializePlaylists().then(() => {
                // Bereinige Favoriten nach dem vollst√§ndigen Laden
                if (cleanupFavorites()) {
                    console.log('Invalid favorites were removed at startup');
                }
                
                // Lade EPG-Daten (falls vorhanden)
                loadEPGData();
                
                // Load current user data if logged in
                loadCurrentUserData();
                
                render();
                applyTheme(); // Theme erneut anwenden nach render
                addSEOFooter(); // Add SEO Footer
                
                // Initialize Cast API
                initCastAPI();
                
                console.log('IPTV Player loaded successfully!');
            }).catch(error => {
                console.error('Fehler beim Laden der Playlists:', error);
                render(); // Render trotzdem, nur ohne Playlists
                applyTheme(); // Theme erneut anwenden
                addSEOFooter(); // Add SEO Footer even on error
            });
            
        } catch (error) {
            console.error('Error loading IPTV Player:', error);
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="bg-red-900/50 border border-red-600 rounded-lg p-6 max-w-md">
                        <h2 class="text-xl font-bold mb-2">‚ö†Ô∏è Loading Error</h2>
                        <p class="text-gray-300">IPTV Player could not be loaded.</p>
                        <p class="text-sm text-gray-400 mt-2">Error: ${error.message}</p>
                        <button onclick="location.reload()" class="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">
                            Reload
                        </button>
                    </div>
                </div>
            `;
        }

        // SEO Footer Function
        function addSEOFooter() {
            const footer = document.createElement('footer');
            footer.className = 'bg-gray-900/50 backdrop-blur border-t border-gray-800 mt-12';
            footer.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <!-- SEO Content Section -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                        <div>
                            <h2 class="text-lg font-bold text-white mb-3">üéØ Free IPTV Player</h2>
                            <p class="text-sm text-gray-400 leading-relaxed">
                                The best free IPTV Player 2025 for Live TV Streaming, watch movies and series online. 
                                Our M3U/M3U8 Player supports HLS streams and offers free TV in the browser. 
                                IPTV - Free TV without registration!
                            </p>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white mb-3">‚ú® Features</h3>
                            <ul class="text-sm text-gray-400 space-y-1">
                                <li>‚Ä¢ M3U and M3U8 Playlist Support</li>
                                <li>‚Ä¢ HLS Live Streaming Player</li>
                                <li>‚Ä¢ Watch TV online for free</li>
                                <li>‚Ä¢ Video on Demand (VOD)</li>
                                <li>‚Ä¢ IPTV Playlist Manager</li>
                                <li>‚Ä¢ Favorites Function</li>
                                <li>‚Ä¢ Manage Multiple Playlists</li>
                                <li>‚Ä¢ Movies & Series Streaming</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white mb-3">üì∫ IPTV Streaming</h3>
                            <p class="text-sm text-gray-400 leading-relaxed mb-3">
                                Watch Live TV for free in your browser. Our IPTV Media Player supports all common 
                                M3U lists and IPTV playlists. Perfect for TV, international channels, 
                                watching movies online and streaming series.
                            </p>
                            <div class="flex flex-wrap gap-2 text-xs">
                                <span class="bg-blue-600/20 text-blue-300 px-2 py-1 rounded">Free IPTV</span>
                                <span class="bg-green-600/20 text-green-300 px-2 py-1 rounded">Live TV</span>
                                <span class="bg-purple-600/20 text-purple-300 px-2 py-1 rounded">M3U Player</span>
                            </div>
                        </div>
                    </div>

                    <!-- Keywords Section (versteckt f√ºr SEO) -->
                    <div class="hidden">
                        <h4>IPTV Player Keywords</h4>
                        <p>
                            iptv player kostenlos, m3u player, m3u8 player, live tv streaming, fernsehen online kostenlos, 
                            iptv deutschland, gratis tv, internet tv, online tv schauen, live stream player, 
                            iptv app kostenlos, web tv player, hls player, video streaming, iptv software, 
                            smart iptv, iptv pro, free iptv, iptv liste, m3u playlist, iptv channels, 
                            tv streaming kostenlos, fernsehen im internet, online mediaplayer, iptv browser, 
                            live tv app, iptv kostenlos deutsch, fernsehen live stream, tv online gucken, 
                            internet fernsehen, web iptv player, iptv m3u, streaming player, vod player, 
                            filme online schauen kostenlos, serien streamen, gratis streaming, online tv player, 
                            iptv receiver, digital tv, live fernsehen, tv stream kostenlos, iptv anbieter, 
                            deutsches fernsehen online, tv sender live, iptv playlist deutsch, m3u8 stream player, 
                            hls streaming, live broadcasting, web streaming, video on demand kostenlos, 
                            gratis filme online, serien kostenlos schauen, iptv legal, bester iptv player, 
                            iptv player 2025, moderne iptv app, iptv playlist manager, multi playlist iptv, 
                            iptv favoriten, iptv kategorien, tv programm online, live tv deutsch, 
                            fernsehen ohne anmeldung, tv schauen kostenlos, iptv player web, browser iptv, 
                            html5 video player, streaming software, media player online, iptv client, 
                            playlist player, m3u file player, m3u8 file player, adaptive streaming, 
                            http live streaming, iptv multicast, unicast streaming, ott player, 
                            over the top streaming, internet protocol television, digital streaming, 
                            live video player, broadcast player, channel player, tv channel streaming
                        </p>
                    </div>

                    <!-- Copyright & Links -->
                    <div class="border-t border-gray-800 pt-6 mt-6">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-gray-500">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <rect width="20" height="15" x="2" y="7" rx="2" ry="2"></rect>
                                    <polyline points="17 2 12 7 7 2"></polyline>
                                </svg>
                                <span>¬© 2025 IPTV Player - Free Live TV Streaming Player</span>
                            </div>
                            <div class="flex gap-4">
                                <a href="#" class="hover:text-blue-400 transition" title="IPTV Player Guide">Help</a>
                                <a href="#" class="hover:text-blue-400 transition" title="Add M3U Playlist">M3U Upload</a>
                                <a href="#" class="hover:text-blue-400 transition" title="IPTV Support">Support</a>
                                <a href="https://paypal.me/ebukyz58" target="_blank" class="hover:text-yellow-400 transition" title="Donate IPTV Player">üíõ Donate</a>
                            </div>
                        </div>
                        <div class="text-center mt-4 text-xs text-gray-600">
                            <p>
                                Best free IPTV Player for M3U/M3U8 Playlists | Live TV Streaming | 
                                Movies & Series Online | HLS Player | IPTV | Free TV | 
                                Web TV Player | VOD Streaming | Smart IPTV Alternative
                            </p>
                        </div>
                    </div>

                    <!-- Structured Data for FAQ -->
                    <scr` + `ipt type="application/ld+json">
                    {
                      "@context": "https://schema.org",
                      "@type": "FAQPage",
                      "mainEntity": [{
                        "@type": "Question",
                        "name": "What is an IPTV Player?",
                        "acceptedAnswer": {
                          "@type": "Answer",
                          "text": "An IPTV Player is software for playing Live TV streams over the internet. Our free IPTV Player supports M3U and M3U8 playlists with HLS streaming."
                        }
                      }, {
                        "@type": "Question",
                        "name": "Is the IPTV Player free?",
                        "acceptedAnswer": {
                          "@type": "Answer",
                          "text": "Yes, our IPTV Player is completely free and requires no registration. You can immediately watch Live TV, movies and series online."
                        }
                      }, {
                        "@type": "Question",
                        "name": "What formats does the player support?",
                        "acceptedAnswer": {
                          "@type": "Answer",
                          "text": "The IPTV Player supports M3U and M3U8 playlist files as well as HLS (HTTP Live Streaming) for optimal video quality."
                        }
                      }, {
                        "@type": "Question",
                        "name": "Can I manage multiple IPTV playlists?",
                        "acceptedAnswer": {
                          "@type": "Answer",
                          "text": "Yes, with our integrated playlist manager you can manage multiple M3U lists and switch between different IPTV sources."
                        }
                      }]
                    }
                    </scr` + `ipt>

                    <!-- BreadcrumbList Structured Data -->
                    <scr` + `ipt type="application/ld+json">
                    {
                      "@context": "https://schema.org",
                      "@type": "BreadcrumbList",
                      "itemListElement": [{
                        "@type": "ListItem",
                        "position": 1,
                        "name": "Home",
                        "item": "https://iptv-player.de/"
                      }, {
                        "@type": "ListItem",
                        "position": 2,
                        "name": "IPTV Player",
                        "item": "https://iptv-player.de/player"
                      }, {
                        "@type": "ListItem",
                        "position": 3,
                        "name": "Live TV Streaming",
                        "item": "https://iptv-player.de/live-tv"
                      }]
                    }
                    <\/script>
                </div>
            `;
            document.body.appendChild(footer);
        }
    </script>
</body>
</html>